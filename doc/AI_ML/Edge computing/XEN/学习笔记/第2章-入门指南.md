[TOC]

Fascinating though the theoretical underpinnings and implementation details of Xen are, we should probably move on to working directly with Xen for a bit of practice. There is, after all, no substitute for experience.

So! Welcome to Xen. This chapter is an easy quick start aimed at gently introducing Xen to one of your machines. We will hold your hand and not let it go.

Because this is a detailed walk-through, we’re going to give focused, specific instructions, deviating from our normal policy of being vague and distro-agnostic. For the purposes of this chapter, we’ll assume you’re installing CentOS 5.x with the server defaults and using its built-in Xen support.

If you’re using something else, this chapter will probably still be useful, but you might have to improvise a bit—the goals will be the same but the steps will probably be different.

In general, the goals for this walk-through are as follows: Make sure your hardware can run Xen.

* 安装基本OS
* 安装Xen
* 熟悉Xen环境
* 安装domU
* 登录domU、配置它，使其一切能够正常工作

# 1. 硬件兼容

首先，确定你的硬件设备可以运行Xen。（虽然几乎所有的机器都可以😊）

奔腾PRO及其以上版本机器，512M内存[^1]，至少几百M的硬盘空间。

Xen目前支持几种主流的处理器架构（X86、AMD、ARM和PowerPC等）。

首先，运行Xen需要一个基本的操作系统。

# 2 安装CentOS

首先，我们正常安装一个`CentOS`操作系统。从启动盘启动后，我们接受默认分区，它将会创建`/boot`分区、`swap`的逻辑卷、`root`逻辑卷，硬盘剩余的空间留给LVM卷组。引导方式也选择默认的GRUB引导程序，网络使用默认配置。

> 确认网络可以正常使用

设置时区，并输入root密码。其余就是CentOS标准安装过程。

接下来，选择虚拟化服务器包，因为它包含Xen软件和支持工具，其余的不需要。如果你想的话，还可以安装其它软件包，比如GNOME桌面程序等，但是不影响本节的内容。

接下来，机器就会按照你的选择进行安装。这会花费一些时间，请耐心等待。安装完成后，完成必要的使用配置。重启。

现在，我们准备好创建一个虚拟机了。但是，首先让我们看看Xen的引导信息，熟悉Xen的环境。

## 2.1 LIVECD

So, you downloaded the LiveCD? May as well try it. It’s pretty slick, but when it’s booted, it’s just another operating system. This captures what makes Xen so fascinating—its sheer banality. After all this work, you wind up sitting in front of a Linux box. Yes, it will pretend to be multiple Linux boxes on demand, but there’s not really much “there” there, to borrow a well-turned phrase from Gertrude Stein.

The LiveCD does showcase some useful features, though. For example, it uses a copy-on-write filesystem to give each Xen domain persistent writable storage across VM reboots. The LiveCD also has some neat scripts that use the XenBus to pop up a VNC console automatically on domU startup. (See Chapter 14 for more information on that.)

It’s a nice demo, but it’s not really useful for production, and it doesn’t give you the sort of hands-on experience that comes with setting up a machine. The other problem is that the LiveCD hasn’t been updated in a while. The last version (as of this writing) is two years old and is based on Xen 3.0.3. There have since been some changes to Xen.

Booting with Xen features extra Xen-specific boot output, as shown in Figure 2-1.

After GRUB loads, it loads the Xen hypervisor, which then takes control of the hardware and outputs its initialization lines (starting with (XEN)). Then it loads the dom0 kernel, which takes over and spews the familiar Linux boot messages that we know and tolerate. (Note that you may not see these messages if you’re using the VGA console, since they go by rather quickly. You can type xm dmesg to see them at any time.)

After the system boots, you should be looking at the normal login prompt, with nary a sign that you’re running in a Xen virtual machine. (Albeit a specially privileged virtual machine.) Now would be a great time to log in, if you haven’t already.

After GRUB loads, it loads the Xen hypervisor, which then takes control of the hardware and outputs its initialization lines (starting with (XEN)). Then it loads the dom0 kernel, which takes over and spews the familiar Linux boot messages that we know and tolerate. (Note that you may not see these messages if you’re using the VGA console, since they go by rather quickly. You can type xm dmesg to see them at any time.)

After the system boots, you should be looking at the normal login prompt, with nary a sign that you’re running in a Xen virtual machine. (Albeit a specially privileged virtual machine.) Now would be a great time to log in, if you haven’t already.

# 3 熟悉Xen

在创建虚拟机之前，先熟悉一下Dom0中的Xen配置文件。在后面的学习中，会经常涉及到这些文件，有必要好好研究一下。

首先，Xen的配置目录一般是`/etc/xen`。大部分的Xen配置都是在这个目录或者`scripts`子目录下完成的。

Xen主要的配置文件是`xend-config.sxp`。在其中，你可以执行启用迁移或指定网络后端等任务。现在，我们使用默认值就可以。

> 详细的设置可以参考第14章。

`/etc/xen/scripts`包含用于处理诸如设置虚拟设备之类的脚本。

最后，Dom域的配置文件也会存放于`/etc/xen`。比如，你可以查看`xmexample1`，会看到很多带有注释的配置示例。

`/etc/init.d`目录包含启停Xen的相关服务。Xen的控制守护进程，`xend`，是位于`/etc/init.d/xend`目录下的一个脚本。尽管大部分时候不需要我们修改它，但是，在这儿可以很方便地修改xend的参数。重启xend最简单的方法就是，运行

    /etc/init.d/xend    restart

命令。Xen的Dom域脚本也很有趣，当系统关机时，它会自动保存Dom域，启动时会自动恢复Dom域。

还有`/boot/grub/menu.lst`文件。它会告诉引导程序-GRUB-引导Xen内核，将Dom0中的Linux内核将为一个模块。使用这个文件，你可以改变Xen和Linux的引导参数。例如，你可以使用参数选项`dom0_mem`为Dom0指定一个固定的内存分配，或者通过linux的选项`nloopbacks`增加网络loopback设备数量。

如果你在CentOS下使用基于文件的虚拟硬盘，并遵循默认的virt-install安装提示，DomU的数据，存储在`/var/lib/xen`目录下的镜像文件中。其它发行版可能有所不同。

## 3.1 xm工具

管理Xen的主要工具是`xm`。它有许多子命令。首先，尝试一下`xm list`命令:

    # xm list
    Name                                       ID Mem(MiB) VCPUs State   Time(s)
    Domain-0                                    0      934   2   r-----  37.6

输出结果显示当前正在运行的Dom域和它们的属性。这儿，我们只看到了Dom0在运行，其ID号为0，内存大小为934M，具有2个虚拟CPU。`r`表示虚拟机正处于运行状态。从启动后已经运行了37.6秒。

> 需要注意的是，`Red Hat`官方不支持`xm`工具，尽管非官方的可以在`RHEL 5.x`上继续运行。基于这个原因，xm的说明文档可能会提到不能在RHEL或者CentOS上工作。RHEL及其兼容版本支持的管理工具是vrish，用于虚拟化shell。

## 3.2 xl工具

    其命名格式和功能基本与xm相同。

# 4 安装DomU

For the moment, since we want to create a domU, the xm subcommand we’re most interested in is create. However, before we can create a domain, we need to create an OS image for it to boot from and use as storage.

Because this is an initial walk-through, we’re going to install our Xen image using Red Hat’s virt-install tool. For information on building your own domU images, take a look at Chapter 3.

Begin by starting virt-install. It’ll start in interactive mode, and have a bit of a conversation with you, as shown. Our inputs are shown in bold. (If you decided to install the GUI, you can also use the graphical virt-manager tool. The prompts will look very similar.)

    # virt-install

    What is the name of your virtual machine? prospero
    How much RAM should be allocated (in megabytes)? 256
    What would you like to use as the disk (file path)? /var/lib/xen/images/prospero.img
    How large would you like the disk (/var/lib/xen/images/prospero.img) to be (in gigabytes)? 4
    Would you like to enable graphics support? (yes or no) no
    What is the install location? http://mirrors.kernel.org/centos/5/os/i386

The machine then begins an interactive network install of CentOS. We won’t go into the details of its operation for now—suffice it to say that great pains have been taken to preserve the appearance of installing an OS on a physical machine. As such, the install process should eerily resemble the one we performed at the start of this chapter. Follow its prompts. (For the curious, we discuss virt-install and its accompanying tools more thoroughly in Chapters 3 and 6.)

Once you’ve made your selections and gone through the install, the machine will reboot. Log in, and then shut the machine down via shutdown -h now (remember, it’s an ordinary Linux box) so that we can look a bit more at things from the dom0 end.

# 4.1 配置文件刨析

Let’s take a moment to examine the config file that virt-install generated for us. As we’ve mentioned already, the config file is /etc/xen/<domain name> by convention.

    # cat /etc/xen/prospero
    name = "prospero"
    uuid = "9f5b38cd-143d-77ce-6dd9-28541d89c02f"
    maxmem = 256
    memory = 256
    vcpus = 1
    bootloader = "/usr/bin/pygrub"
    on_poweroff = "destroy"
    on_reboot = "restart"
    on_crash = "restart"
    vfb = [ ]
    disk = [ "tap:aio:/opt/xen/images/prospero.img,xvda,w" ]
    vif = [ "mac=00:16:3e:63:b7:a0,bridge=xenbr0" ]

As you see, the file consists of simple name=value pairs, with Python-style lists in square brackets. Note the values that we specified in the virt-install session, plugged into appropriate places—the name, the memory amount, and the disk image. virt-install also fills in some network configuration, specifying a MAC address and dom0-level bridge device.

We’ll examine many of the config file parameters more deeply in subsequent chapters. For now, let’s just move on to seeing the effects of these values on our domain.

# 5 配置DomU

Finally, start the image! We’ll run xm with the create subcommand, which expects a config file name as an argument. We can omit the path, since it defaults to looking in /etc/xen.

    # xm create -c prospero

Since we passed the -c option to xm create, it’ll immediately connect us to the domain’s console, so that we can interact with the bootloader. Hit ENTER to boot with default options, and watch it go.

Once it boots, you should be looking at the console of a shiny new Xen domU, as illustrated in Figure 2-2. Log in as root and frolic.

Start by looking at the output of the dmesg command within the domU. Note that the disk and network devices are Xen’s special paravirtualized devices.

You can also take a look at the domU’s networking, which is essentially indistinguishable from that of a normal Linux system:

    # ifconfig eth0
    eth0       Link encap:Ethernet HWaddr 00:16:3E:63:B7:A0
               inet addr:216.218.223.74 Bcast:216.218.223.127 Mask:255.255.255.192
               inet6 addr: 2001:470:1:41:a800:ff:fe53:314a/64 Scope:Global
               inet6 addr: fe80::a800:ff:fe53:314a/64 Scope:Link
               UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1

               RX packets:73650errors:0 dropped:0 overruns:0 frame:0
               TX packets:49731 errors:0 dropped:0 overruns:0 carrier:0
               collisions:0 txqueuelen:1000
               TX bytes:106033983 (101.1 MiB)       RX bytes:2847950 (2.7 MiB)


Note that we’re using standard commands—one of the major features of Xen is that most of the management takes place via familiar Linux commands. This makes it easy to customize your Xen environment, usually by making changes to the support scripts. Furthermore, standard commands will generally behave in expected ways—for example, you can give yourself a new IP address via ifconfig, and it’ll work just as it would on a physical machine.[^2]

Let’s return to the dom0 for a moment, just to take a look at the running domain from outside. To break out of the domU’s console, type CTRL-]. You can reconnect at any time by running xm console <domU name or id> from the dom0.

Now that we’re back in the dom0, we can note that our new domain shows up in xm list, consuming memory and CPU time:

    # xm list
    Name                                         ID Mem(MiB) VCPUs State   Time(s)
    Domain-0                                      0    739     2   r-----   136.7
    prospero                                      1    255     1   -b----   116.1

And that it’s got a visible network device:

    # ifconfig vif1.0
    vif1.0     Link encap:Ethernet HWaddr FE:FF:FF:FF:FF:FF
               inet6 addr: fe80::fcff:ffff:feff:ffff/64 Scope:Link
               UP BROADCAST RUNNING NOARP MTU:1500 Metric:1
               RX packets:49731 errors:0 dropped:0 overruns:0 frame:0
               TX packets:73650 errors:0 dropped:0 overruns:0 carrier:0
               collisions:0 txqueuelen:32
               RX bytes:2847950 (2.7 MiB) TX bytes:106033983 (101.1 MiB)

Some points to mention about the network device: First, it’s got a dummy MAC address. You can see the actual MAC address of the virtual Ethernet device from within the domU. Second, the counters are reversed— the domain’s actually downloaded 100MiB, and transmitted 2.7. Third, both IPv4 and IPv6 “just work” with the default setup. We go into further detail in Chapter 5. From here you can treat the domain just like any other Linux box. You can set up users on it, SSH into it, or access its console via <t>xm console. You can reboot it via the xm reboot command, and shut it down using xm shutdown.

# 6 试用

# 7 注释

[^1]: The absolute minimum would probably be 128MiB, but CentOS itself requires 256, and each domU will also require a significant amount of memory.

[^2]: The administrator can disable this, however. You’ll still be able to change the IP from the domU, but the dom0 will block traffic from the new IP. See Chapter 5 for details.