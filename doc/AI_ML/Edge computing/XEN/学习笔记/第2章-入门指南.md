[TOC]

æœ¬æ–‡ä¸»è¦ä»å¤´åˆ°å°¾ç†Ÿæ‚‰ä¸€éXençš„ä½¿ç”¨ï¼ŒåŒ…å«ä¸‹é¢è¿™äº›æ­¥éª¤ï¼š

* å®‰è£…åŸºæœ¬OS
* å®‰è£…Xen
* ç†Ÿæ‚‰Xenç¯å¢ƒ
* å®‰è£…domU
* ç™»å½•domUã€é…ç½®å®ƒï¼Œä½¿å…¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œ

# 1. ç¡¬ä»¶å…¼å®¹

é¦–å…ˆï¼Œç¡®å®šä½ çš„ç¡¬ä»¶è®¾å¤‡å¯ä»¥è¿è¡ŒXenã€‚ï¼ˆè™½ç„¶å‡ ä¹æ‰€æœ‰çš„æœºå™¨éƒ½å¯ä»¥ğŸ˜Šï¼‰ è¦æ±‚ï¼šå¥”è…¾PROåŠå…¶ä»¥ä¸Šæœºå™¨ç‰ˆæœ¬ï¼Œ512Må†…å­˜[^1]ï¼Œè‡³å°‘å‡ ç™¾Mçš„ç¡¬ç›˜ç©ºé—´ã€‚

Xenç›®å‰æ”¯æŒå‡ ç§ä¸»æµçš„å¤„ç†å™¨æ¶æ„ï¼ˆX86ã€AMDã€ARMå’ŒPowerPCç­‰ï¼‰ã€‚

é¦–å…ˆï¼Œè¿è¡ŒXenéœ€è¦ä¸€ä¸ªåŸºæœ¬çš„æ“ä½œç³»ç»Ÿã€‚

# 2 å®‰è£…CentOS

é¦–å…ˆï¼Œæˆ‘ä»¬æ­£å¸¸å®‰è£…ä¸€ä¸ª`CentOS`æ“ä½œç³»ç»Ÿã€‚ä»å¯åŠ¨ç›˜å¯åŠ¨åï¼Œæˆ‘ä»¬æ¥å—é»˜è®¤åˆ†åŒºï¼Œå®ƒå°†ä¼šåˆ›å»º`/boot`åˆ†åŒºã€`swap`çš„é€»è¾‘å·ã€`root`é€»è¾‘å·ï¼Œå‰©ä½™çš„ç¡¬ç›˜ç©ºé—´ç•™ç»™LVMå·ç»„ã€‚å¼•å¯¼æ–¹å¼ä¹Ÿé€‰æ‹©é»˜è®¤çš„GRUBå¼•å¯¼ç¨‹åºï¼Œç½‘ç»œä½¿ç”¨é»˜è®¤é…ç½®ã€‚

> ç¡®è®¤ç½‘ç»œå¯ä»¥æ­£å¸¸ä½¿ç”¨

è®¾ç½®æ—¶åŒºï¼Œå¹¶è¾“å…¥rootå¯†ç ã€‚å…¶ä½™å°±æ˜¯CentOSæ ‡å‡†å®‰è£…è¿‡ç¨‹ï¼Œåœ¨æ­¤ï¼Œä¸å†èµ˜è¿°ã€‚

æ¥ä¸‹æ¥ï¼Œé€‰æ‹©XenServeråŒ…ï¼Œå› ä¸ºå®ƒåŒ…å«Xenè½¯ä»¶å’Œæ”¯æŒå·¥å…·ï¼Œå…¶ä½™çš„ä¸éœ€è¦ã€‚å¦‚æœä½ æƒ³çš„è¯ï¼Œè¿˜å¯ä»¥å®‰è£…å…¶å®ƒè½¯ä»¶åŒ…ï¼Œæ¯”å¦‚GNOMEæ¡Œé¢ç¨‹åºç­‰ï¼Œä½†æ˜¯ä¸å½±å“æœ¬èŠ‚çš„å†…å®¹ã€‚

æ¥ä¸‹æ¥ï¼Œæœºå™¨å°±ä¼šæŒ‰ç…§é…ç½®è¿›è¡Œå®‰è£…ã€‚è¿™ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚å®‰è£…å®Œæˆåï¼Œå®Œæˆå¿…è¦çš„ä½¿ç”¨é…ç½®ã€‚é‡å¯ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å‡†å¤‡å¥½åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºäº†ã€‚

# 3 ç†Ÿæ‚‰Xen

åœ¨æˆ‘ä»¬åˆ›å»ºXenè™šæ‹Ÿæœºä¹‹å‰ï¼Œé¦–å…ˆç†Ÿæ‚‰å‡ ä¸ªæ¦‚å¿µã€‚æ›´å¤šçš„æ¦‚å¿µéšç€æ–‡ç« çš„æ·±å…¥ï¼Œæˆ‘ä»¬ä¼šæ…¢æ…¢æ­å¼€å®ƒä»¬çš„å¤´çº±ğŸ˜Šï¼ï¼ï¼

## 3.1 Dom0é…ç½®æ–‡ä»¶

åœ¨åˆ›å»ºè™šæ‹Ÿæœºä¹‹å‰ï¼Œå…ˆç†Ÿæ‚‰ä¸€ä¸‹Dom0ä¸­çš„Xené…ç½®æ–‡ä»¶ã€‚åœ¨åé¢çš„å­¦ä¹ ä¸­ï¼Œä¼šç»å¸¸æ¶‰åŠåˆ°è¿™äº›æ–‡ä»¶ï¼Œæœ‰å¿…è¦å¥½å¥½ç ”ç©¶ä¸€ä¸‹ã€‚

é¦–å…ˆï¼ŒXençš„é…ç½®ç›®å½•ä¸€èˆ¬æ˜¯`/etc/xen`ã€‚å¤§éƒ¨åˆ†çš„Xené…ç½®éƒ½æ˜¯åœ¨è¿™ä¸ªç›®å½•æˆ–è€…`scripts`å­ç›®å½•ä¸‹å®Œæˆçš„ã€‚

Xenä¸»è¦çš„é…ç½®æ–‡ä»¶æ˜¯`xend-config.sxp`ã€‚åœ¨å…¶ä¸­ï¼Œä½ å¯ä»¥æ‰§è¡Œå¯ç”¨è¿ç§»æˆ–æŒ‡å®šç½‘ç»œåç«¯ç­‰ä»»åŠ¡ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨é»˜è®¤å€¼å°±å¯ä»¥ã€‚

> è¯¦ç»†çš„è®¾ç½®å¯ä»¥å‚è€ƒç¬¬14ç« ã€‚

`/etc/xen/scripts`åŒ…å«ç”¨äºå¤„ç†è¯¸å¦‚è®¾ç½®è™šæ‹Ÿè®¾å¤‡ä¹‹ç±»çš„è„šæœ¬ã€‚

æœ€åï¼ŒDomåŸŸçš„é…ç½®æ–‡ä»¶ä¹Ÿä¼šå­˜æ”¾äº`/etc/xen`ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥æŸ¥çœ‹`xmexample1`ï¼Œä¼šçœ‹åˆ°å¾ˆå¤šå¸¦æœ‰æ³¨é‡Šçš„é…ç½®ç¤ºä¾‹ã€‚

`/etc/init.d`ç›®å½•åŒ…å«å¯åœXençš„ç›¸å…³æœåŠ¡ã€‚Xençš„æ§åˆ¶å®ˆæŠ¤è¿›ç¨‹æ˜¯`xend`ï¼Œæ˜¯ä½äº`/etc/init.d/xend`ç›®å½•ä¸‹çš„ä¸€ä¸ªè„šæœ¬ã€‚å°½ç®¡å¤§éƒ¨åˆ†æ—¶å€™ä¸éœ€è¦æˆ‘ä»¬ä¿®æ”¹å®ƒï¼Œä½†æ˜¯ï¼Œåœ¨è¿™å„¿å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä¿®æ”¹xendçš„å‚æ•°ã€‚é‡å¯xendçš„æ–¹æ³•æ˜¯ï¼Œ

    /etc/init.d/xend    restart

Xençš„DomåŸŸè„šæœ¬ï¼Œå½“ç³»ç»Ÿå…³æœºæ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨ä¿å­˜DomåŸŸï¼Œå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ¢å¤DomåŸŸã€‚

è¿˜æœ‰`/boot/grub/menu.lst`æ–‡ä»¶ã€‚å®ƒä¼šå‘Šè¯‰å¼•å¯¼ç¨‹åº-GRUB-å¼•å¯¼Xenå†…æ ¸ï¼Œå°†Dom0ä¸­çš„Linuxå†…æ ¸å°†ä¸ºä¸€ä¸ªæ¨¡å—ã€‚ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ï¼Œä½ å¯ä»¥æ”¹å˜Xenå’ŒLinuxçš„å¼•å¯¼å‚æ•°ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨å‚æ•°é€‰é¡¹`dom0_mem`ä¸ºDom0æŒ‡å®šä¸€ä¸ªå›ºå®šçš„å†…å­˜åˆ†é…ï¼Œæˆ–è€…é€šè¿‡linuxçš„é€‰é¡¹`nloopbacks`å¢åŠ ç½‘ç»œloopbackè®¾å¤‡æ•°é‡ã€‚

å¦‚æœä½ åœ¨CentOSä¸‹ä½¿ç”¨åŸºäºæ–‡ä»¶çš„è™šæ‹Ÿç¡¬ç›˜ï¼Œå¹¶éµå¾ªé»˜è®¤çš„virt-installå®‰è£…æç¤ºï¼ŒDomUçš„æ•°æ®ï¼Œå­˜å‚¨åœ¨`/var/lib/xen`ç›®å½•ä¸‹çš„é•œåƒæ–‡ä»¶ä¸­ã€‚å…¶å®ƒå‘è¡Œç‰ˆå¯èƒ½æœ‰æ‰€ä¸åŒã€‚

## 3.1 xlå·¥å…·

ç®¡ç†Xençš„ä¸»è¦å·¥å…·æ˜¯`xm`ã€‚å®ƒæœ‰è®¸å¤šå­å‘½ä»¤ã€‚é¦–å…ˆï¼Œå°è¯•ä¸€ä¸‹`xm list`å‘½ä»¤:

    # xl list
    Name                                       ID Mem(MiB) VCPUs State   Time(s)
    Domain-0                                    0      934   2   r-----  37.6

è¾“å‡ºç»“æœæ˜¾ç¤ºå½“å‰æ­£åœ¨è¿è¡Œçš„DomåŸŸå’Œå®ƒä»¬çš„å±æ€§ã€‚è¿™å„¿ï¼Œæˆ‘ä»¬åªçœ‹åˆ°äº†Dom0åœ¨è¿è¡Œï¼Œå…¶IDå·ä¸º0ï¼Œå†…å­˜å¤§å°ä¸º934Mï¼Œå…·æœ‰2ä¸ªè™šæ‹ŸCPUã€‚`r`è¡¨ç¤ºè™šæ‹Ÿæœºæ­£å¤„äºè¿è¡ŒçŠ¶æ€ã€‚ä»å¯åŠ¨åå·²ç»è¿è¡Œäº†37.6ç§’ã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`Red Hat`å®˜æ–¹ä¸æ”¯æŒ`xm`å·¥å…·ï¼Œå°½ç®¡éå®˜æ–¹çš„å¯ä»¥åœ¨`RHEL 5.x`ä¸Šç»§ç»­è¿è¡Œã€‚åŸºäºè¿™ä¸ªåŸå› ï¼Œxmçš„è¯´æ˜æ–‡æ¡£å¯èƒ½ä¼šæåˆ°ä¸èƒ½åœ¨RHELæˆ–è€…CentOSä¸Šå·¥ä½œã€‚RHELåŠå…¶å…¼å®¹ç‰ˆæœ¬æ”¯æŒçš„ç®¡ç†å·¥å…·æ˜¯vrishï¼Œç”¨äºè™šæ‹ŸåŒ–shellã€‚

## 3.2 xmå·¥å…·

    å…¶å‘½åæ ¼å¼å’ŒåŠŸèƒ½åŸºæœ¬ä¸xmç›¸åŒã€‚

# 4 å®‰è£…DomU

ç›®å‰ï¼Œç”±äºæˆ‘ä»¬å¸Œæœ›åˆ›å»ºä¸€ä¸ªDomUï¼Œæ‰€ä»¥ï¼Œæœ€å…³å¿ƒçš„xlå­å‘½ä»¤è¿˜æ˜¯createã€‚ä½†æ˜¯ï¼Œåœ¨æˆ‘ä»¬åˆ›å»ºDomUä¹‹å‰ï¼Œå¿…é¡»å…ˆæ„å»ºä¸€ä¸ªOSé•œåƒï¼Œä»¥ä¾¿å¼•å¯¼å®ƒï¼Œå¹¶å°†å…¶ä½œä¸ºå­˜å‚¨ä»‹è´¨ã€‚

å› ä¸ºä¸»è¦æ˜¯æƒ³ç®€å•ç†Ÿæ‚‰ä¸€ä¸‹Xençš„ä½¿ç”¨æµç¨‹ï¼Œæ‰€ä»¥é€‰æ‹©ä½¿ç”¨Red Hatçš„`virt-install`å®‰è£…å·¥å…·ã€‚è‡³äºå¦‚ä½•æ„å»ºè‡ªå®šä¹‰çš„DomUé•œåƒæ–‡ä»¶ï¼Œå‚è€ƒ[ç¬¬3ç« ](TODO)ã€‚


Begin by starting virt-install. Itâ€™ll start in interactive mode, and have a bit of a conversation with you, as shown. Our inputs are shown in bold. (If you decided to install the GUI, you can also use the graphical virt-manager tool. The prompts will look very similar.)

    # virt-install

    What is the name of your virtual machine? prospero
    How much RAM should be allocated (in megabytes)? 256
    What would you like to use as the disk (file path)? /var/lib/xen/images/prospero.img
    How large would you like the disk (/var/lib/xen/images/prospero.img) to be (in gigabytes)? 4
    Would you like to enable graphics support? (yes or no) no
    What is the install location? http://mirrors.kernel.org/centos/5/os/i386

The machine then begins an interactive network install of CentOS. We wonâ€™t go into the details of its operation for nowâ€”suffice it to say that great pains have been taken to preserve the appearance of installing an OS on a physical machine. As such, the install process should eerily resemble the one we performed at the start of this chapter. Follow its prompts. (For the curious, we discuss virt-install and its accompanying tools more thoroughly in Chapters 3 and 6.)

Once youâ€™ve made your selections and gone through the install, the machine will reboot. Log in, and then shut the machine down via shutdown -h now (remember, itâ€™s an ordinary Linux box) so that we can look a bit more at things from the dom0 end.

# 4.1 é…ç½®æ–‡ä»¶åˆ¨æ

Letâ€™s take a moment to examine the config file that virt-install generated for us. As weâ€™ve mentioned already, the config file is /etc/xen/<domain name> by convention.

    # cat /etc/xen/prospero
    name = "prospero"
    uuid = "9f5b38cd-143d-77ce-6dd9-28541d89c02f"
    maxmem = 256
    memory = 256
    vcpus = 1
    bootloader = "/usr/bin/pygrub"
    on_poweroff = "destroy"
    on_reboot = "restart"
    on_crash = "restart"
    vfb = [ ]
    disk = [ "tap:aio:/opt/xen/images/prospero.img,xvda,w" ]
    vif = [ "mac=00:16:3e:63:b7:a0,bridge=xenbr0" ]

As you see, the file consists of simple name=value pairs, with Python-style lists in square brackets. Note the values that we specified in the virt-install session, plugged into appropriate placesâ€”the name, the memory amount, and the disk image. virt-install also fills in some network configuration, specifying a MAC address and dom0-level bridge device.

Weâ€™ll examine many of the config file parameters more deeply in subsequent chapters. For now, letâ€™s just move on to seeing the effects of these values on our domain.

# 5 é…ç½®DomU

Finally, start the image! Weâ€™ll run xm with the create subcommand, which expects a config file name as an argument. We can omit the path, since it defaults to looking in /etc/xen.

    # xm create -c prospero

Since we passed the -c option to xm create, itâ€™ll immediately connect us to the domainâ€™s console, so that we can interact with the bootloader. Hit ENTER to boot with default options, and watch it go.

Once it boots, you should be looking at the console of a shiny new Xen domU, as illustrated in Figure 2-2. Log in as root and frolic.

Start by looking at the output of the dmesg command within the domU. Note that the disk and network devices are Xenâ€™s special paravirtualized devices.

You can also take a look at the domUâ€™s networking, which is essentially indistinguishable from that of a normal Linux system:

    # ifconfig eth0
    eth0       Link encap:Ethernet HWaddr 00:16:3E:63:B7:A0
               inet addr:216.218.223.74 Bcast:216.218.223.127 Mask:255.255.255.192
               inet6 addr: 2001:470:1:41:a800:ff:fe53:314a/64 Scope:Global
               inet6 addr: fe80::a800:ff:fe53:314a/64 Scope:Link
               UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1

               RX packets:73650errors:0 dropped:0 overruns:0 frame:0
               TX packets:49731 errors:0 dropped:0 overruns:0 carrier:0
               collisions:0 txqueuelen:1000
               TX bytes:106033983 (101.1 MiB)       RX bytes:2847950 (2.7 MiB)


Note that weâ€™re using standard commandsâ€”one of the major features of Xen is that most of the management takes place via familiar Linux commands. This makes it easy to customize your Xen environment, usually by making changes to the support scripts. Furthermore, standard commands will generally behave in expected waysâ€”for example, you can give yourself a new IP address via ifconfig, and itâ€™ll work just as it would on a physical machine.[^2]

Letâ€™s return to the dom0 for a moment, just to take a look at the running domain from outside. To break out of the domUâ€™s console, type CTRL-]. You can reconnect at any time by running xm console <domU name or id> from the dom0.

Now that weâ€™re back in the dom0, we can note that our new domain shows up in xm list, consuming memory and CPU time:

    # xm list
    Name                                         ID Mem(MiB) VCPUs State   Time(s)
    Domain-0                                      0    739     2   r-----   136.7
    prospero                                      1    255     1   -b----   116.1

And that itâ€™s got a visible network device:

    # ifconfig vif1.0
    vif1.0     Link encap:Ethernet HWaddr FE:FF:FF:FF:FF:FF
               inet6 addr: fe80::fcff:ffff:feff:ffff/64 Scope:Link
               UP BROADCAST RUNNING NOARP MTU:1500 Metric:1
               RX packets:49731 errors:0 dropped:0 overruns:0 frame:0
               TX packets:73650 errors:0 dropped:0 overruns:0 carrier:0
               collisions:0 txqueuelen:32
               RX bytes:2847950 (2.7 MiB) TX bytes:106033983 (101.1 MiB)

Some points to mention about the network device: First, itâ€™s got a dummy MAC address. You can see the actual MAC address of the virtual Ethernet device from within the domU. Second, the counters are reversedâ€” the domainâ€™s actually downloaded 100MiB, and transmitted 2.7. Third, both IPv4 and IPv6 â€œjust workâ€ with the default setup. We go into further detail in Chapter 5. From here you can treat the domain just like any other Linux box. You can set up users on it, SSH into it, or access its console via <t>xm console. You can reboot it via the xm reboot command, and shut it down using xm shutdown.

# 6 è¯•ç”¨

# 7 æ³¨é‡Š

[^1]: The absolute minimum would probably be 128MiB, but CentOS itself requires 256, and each domU will also require a significant amount of memory.

[^2]: The administrator can disable this, however. Youâ€™ll still be able to change the IP from the domU, but the dom0 will block traffic from the new IP. See Chapter 5 for details.