è¿™æ˜¯ä¸€ç¯‡å‘åˆå­¦è€…ä»‹ç»Xenç›¸å…³çš„åŸºæœ¬æ¦‚å¿µï¼Œä»¥åŠå¦‚ä½•åœ¨æ²¡æœ‰ç»éªŒçš„æƒ…å†µä¸‹å¯åŠ¨Xené¡¹ç›®çš„æŒ‡å¯¼æ‰‹å†Œã€‚ä½†æ˜¯ï¼Œä¸€äº›Linuxçš„ç»éªŒè¿˜æ˜¯å¿…è¦çš„ï¼Œæ¯”å¦‚ç½‘ç»œã€lvmå’Œgrubï¼Œè¿™å¯¹äºXençš„ç†è§£å’Œä½¿ç”¨å¤§æœ‰è£¨ç›Šã€‚å¦å¤–ï¼Œè¿˜åº”è¯¥ç†Ÿæ‚‰åœ¨rootæƒé™ä¸‹çš„æ“ä½œæ–¹æ³•ã€‚å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨rootæƒé™ä¸‹è¿›è¡Œæ“ä½œã€‚

å®Œæˆæœ¬æ‰‹å†Œï¼Œä½ å°±æ‹¥æœ‰äº†ä¸€ä¸ªå…¨åŠŸèƒ½çš„Xenç›‘æ§ç¨‹åºï¼Œå¹¶ä¸”èƒ½å¤Ÿå¯åŠ¨ç¬¬ä¸€ä¸ªå®¢æˆ·æ“ä½œç³»ç»Ÿã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œä½ å¯ä»¥å°†å…¶æ¥å…¥ç½‘ç»œï¼Œå­¦ä¹ ä¸€äº›å…¶å®ƒçš„åŸºæœ¬çŸ¥è¯†ï¼Œæ¯”å¦‚è™šæ‹Ÿæœºå­˜å‚¨å’Œè™šæ‹Ÿç½‘ç»œã€‚

ä¸ºäº†ç®€åŒ–æœ¬æ–‡çš„è¿‡ç¨‹ï¼Œç›´æ¥ä½¿ç”¨äº†ä¸€ä¸ªLinuxçš„å‘è¡Œç‰ˆæœ¬ï¼ŒDebianã€‚æœ¬æ–‡æ¡£æœ€åˆç¼–å†™çš„æ—¶å€™ï¼Œä½¿ç”¨äº†Debian6/7ï¼ˆåˆ†åˆ«ç§°ä¹‹ä¸º`Wheezy`å’Œ`Wheezy`ï¼‰ï¼Œå¹¶ä¸”åœ¨æœ€æ–°çš„Debian10ï¼ˆç§°ä¸º`Buster`ï¼‰ä¸Šè¿›è¡Œäº†æµ‹è¯•ã€‚åœ¨è¾ƒæ–°ç‰ˆæœ¬ä¸Šåº”è¯¥ä¹Ÿå¯ä»¥è¿è¡Œã€‚Debianå¯¹`Xen 4.x`æ”¯æŒè¾ƒå¥½ã€‚

[TOC]

# 1 Xenæ˜¯ä»€ä¹ˆ?

Xené¡¹ç›®æ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºç›‘æ§è½¯ä»¶ï¼Œä¹Ÿç§°ä¸º`hypervisor`ï¼šæ˜¯ä¸€ä¸ªå…è®¸å¤šä¸ªè™šæ‹Ÿå®¢æˆ·æœºæ“ä½œç³»ç»Ÿè¿è¡Œåœ¨åŒä¸€ä¸ªç‰©ç†æœºä¸Šçš„è½¯ä»¶ç³»ç»Ÿã€‚å®ƒåˆ›å»ºä¸€ä¸ªç±»å‹1çš„hypervisorç›‘æ§ç¨‹åºï¼Œè¿™æ„å‘³ç€å®ƒç›´æ¥è¿è¡Œåœ¨ç‰©ç†æœºä¸Šï¼Œè€Œä¸æ˜¯æ“ä½œç³»ç»Ÿä¹‹ä¸Šã€‚

è¿è¡Œåœ¨Xenä¹‹ä¸Šçš„è™šæ‹Ÿå®¢æˆ·æœºç§°ä¸º`domain`ã€‚domain0æˆ–è€…dom0æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ§åˆ¶åŸŸï¼Œç”¨æ¥ç®¡ç†Xenç¨‹åºå¹¶å¯åŠ¨å…¶å®ƒå®¢æˆ·æœºæ“ä½œç³»ç»Ÿã€‚å…¶å®ƒçš„è™šæ‹Ÿæœºç§°ä¸ºdomUï¼Œå®ƒä»¬è¿è¡Œçš„éç‰¹æƒæ¨¡å¼ä¸‹ï¼Œä¸èƒ½æ§åˆ¶Xenç¨‹åºæˆ–å¯åœå…¶å®ƒè™šæ‹Ÿæœºã€‚

Xenç›‘æ§ç¨‹åºæ”¯æŒä¸¤ç§è™šæ‹ŸåŒ–ï¼šåŠè™šæ‹ŸåŒ–ï¼ˆPVï¼‰å’Œå…¨è™šæ‹ŸåŒ–ï¼ˆç¡¬ä»¶è™šæ‹ŸåŒ–ï¼‰ã€‚åŠè™šæ‹ŸåŒ–éœ€è¦ä¿®æ”¹å®¢æˆ·æ“ä½œç³»ç»Ÿï¼Œè¿™äº›æ“ä½œç³»ç»ŸçŸ¥é“å®ƒä»¬æ­£åœ¨è¢«è™šæ‹ŸåŒ–ï¼Œå› æ­¤ä¸éœ€è¦è™šæ‹Ÿç¡¬ä»¶è®¾å¤‡ã€‚ç›¸åï¼Œå®ƒä»¬è°ƒç”¨hypervisorçš„ç‰¹æ®Šæ¥å£ï¼Œè®¿é—®CPUï¼Œå­˜å‚¨è®¾å¤‡å’Œç½‘ç»œèµ„æºã€‚

ç›¸åï¼Œå…¨è™šæ‹ŸåŒ–ï¼ˆHVMï¼‰ä¸éœ€è¦ä¿®æ”¹å®¢æˆ·æœºæ“ä½œç³»ç»Ÿï¼Œå› ä¸ºå®ƒä¼šå®Œå…¨æ¨¡æ‹Ÿä¸€ä¸ªç‰©ç†è®¡ç®—æœºè®¾å¤‡ã€‚æ‰€ä»¥ï¼Œç›¸æ¯”åŠè™šæ‹ŸåŒ–ï¼Œå…¶å…è®¸ä¸ä¿®æ”¹å®¢æˆ·æœºæ“ä½œç³»ç»Ÿï¼Œä½†æ˜¯ç‰ºç‰²äº†æ›´å¤šçš„æ€§èƒ½ã€‚HVMéœ€è¦CPUæ”¯æŒè™šæ‹ŸåŒ–æ‰©å±•åŠŸèƒ½ï¼Œç†ŸçŸ¥çš„æœ‰è‹±ç‰¹å°”çš„V-Tå’ŒAMDå…¬å¸çš„AMD-Vã€‚

Xenè™šæ‹ŸåŒ–å®ç°èŒƒå›´ä»‹äºåŠè™šæ‹ŸåŒ–å’Œç¡¬ä»¶è™šæ‹ŸåŒ–ä¹‹é—´ï¼Œåœ¨å…¶ä¸­è¿˜æœ‰è®¸å¤šå˜ä½“ï¼Œæ¯”å¦‚å¸¦æœ‰åŠè™šæ‹ŸåŒ–é©±åŠ¨çš„ç¡¬ä»¶è™šæ‹Ÿæœºï¼Œæˆ–è€…åœ¨ç¡¬ä»¶è™šæ‹Ÿæœºä¸Šå®ç°åŠè™šæ‹ŸåŒ–ç­‰ã€‚ä¹‹æ‰€ä»¥ï¼Œå­˜åœ¨è¿™äº›å˜ä½“ï¼Œéƒ½æ˜¯ä¸ºäº†æé«˜å®ƒä»¬çš„æ€§èƒ½ã€‚ä¸ºäº†ç®€åŒ–æœ¬æ‰‹å†Œï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé€šç”¨åŠè™šæ‹ŸåŒ–VMå’Œä¸€ä¸ªå¯é€‰çš„ç¡¬ä»¶è™šæ‹ŸåŒ–çš„å®¢æˆ·æœºã€‚å¯¹äºå…¶å®ƒçš„å˜ä½“ï¼Œå¯ä»¥æŸ¥çœ‹ä¸‹é¢è¿™ç¯‡æ–‡ç« ï¼š

* [Understanding the Virtualization Spectrum](https://wiki.xenproject.org/wiki/Understanding_the_Virtualization_Spectrum)


# 2 Xenæ¶æ„ç®€ä»‹

ä¸ºäº†ç†è§£å­˜å‚¨ã€ç½‘ç»œå’Œå…¶å®ƒèµ„æºå¦‚ä½•è¢«æ´¾å‘åˆ°å®¢æˆ·ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ·±å…¥ç ”ç©¶ä¸€ä¸‹è½¯ä»¶çš„ä¸åŒéƒ¨åˆ†æ˜¯å¦‚ä½•äº¤äº’çš„ã€‚

<img src="https://raw.githubusercontent.com/tupelo-shen/my_test/master/doc/AI_ML/Edge%20computing/XEN/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/images/Xen_beginner_guide_XenArch1_1.png">

è¿™æ˜¯Xençš„åŸºæœ¬æ¶æ„ï¼Œå¯ä»¥çœ‹å‡ºï¼Œç›‘æ§ç¨‹åºç›´æ¥è¿è¡Œåœ¨è£¸æœºä¹‹ä¸Šã€‚è™šæ‹Ÿæœºè¿è¡Œåœ¨ç›‘æ§ç¨‹åºä¹‹ä¸Šï¼Œæ¯”å¦‚Dom0ï¼ˆæ§åˆ¶åŸŸï¼‰ã€‚Dom0æœ‰ä¸¤ä¸ªä¸åŒäºå…¶å®ƒè™šæ‹Ÿæœºçš„åŠŸèƒ½ï¼š

1. Dom0æœ‰èƒ½åŠ›è°ƒç”¨ç›‘æ§ç¨‹åºï¼Œä»è€Œå¯åœå…¶å®ƒè™šæ‹Ÿæœºã€‚

2. é»˜è®¤æƒ…å†µä¸‹ï¼ŒDom0åŒ…å«è®¿é—®ç¡¬ä»¶è®¾å¤‡çš„é©±åŠ¨ç¨‹åºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒXenç›‘æ§ç¨‹åºé€šè¿‡ä½¿ç”¨Dom0ä¸­çš„é©±åŠ¨ç¨‹åºæ¥è®¿é—®ä¸åŒçš„ç¡¬ä»¶è®¾å¤‡ã€‚

<img src="https://raw.githubusercontent.com/tupelo-shen/my_test/master/doc/AI_ML/Edge%20computing/XEN/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/images/Xen_beginner_guide_XenArch2_2.png">

Dom0é‡è¦çš„åŠŸèƒ½ä¹‹ä¸€å°±æ˜¯æä¾›ç›‘æ§ç¨‹åºçš„æ¥å£ã€‚é€šè¿‡ç‰¹æ®Šçš„æŒ‡ä»¤ï¼ŒDom0å’ŒXenç›‘æ§ç¨‹åºè¿›è¡Œé€šä¿¡ï¼Œå¹¶é…ç½®å®ƒã€‚è¿™åŒ…å«å®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„åŸŸå’Œç›¸å…³ä»»åŠ¡ã€‚

Dom0ï¼Œå¦å¤–ä¸€ä¸ªé‡è¦çš„è§’è‰²å°±æ˜¯ä½œä¸ºç¡¬ä»¶è®¾å¤‡çš„æ¥å£ã€‚ç›‘æ§ç¨‹åºå¹¶ä¸åŒ…å«è®¾å¤‡é©±åŠ¨ã€‚ç›¸åï¼Œè®¾å¤‡éƒ½ä¾é™„äºDom0ï¼Œä½¿ç”¨æ ‡å‡†çš„Linuxé©±åŠ¨ã€‚Dom0ä¸å…¶å®ƒè™šæ‹Ÿæœºå…±äº«è¿™äº›èµ„æºã€‚

ä¸ºäº†å®ç°åŠè™šæ‹ŸåŒ–ï¼Œæ¯ä¸ªè®¾å¤‡çš„æ¨¡æ‹Ÿåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

1. å­˜åœ¨äºDom0ä¸­çš„`åç«¯`ï¼Œæä¾›è™šæ‹Ÿè®¾å¤‡ï¼›
2. å­˜åœ¨äºå…¶å®ƒDomUä¸­çš„`å‰ç«¯é©±åŠ¨`ï¼Œå…è®¸å®¢æˆ·æœºæ“ä½œç³»ç»Ÿè®¿é—®è™šæ‹Ÿè®¾å¤‡ã€‚

åç«¯å’Œå‰ç«¯é©±åŠ¨é€šè¿‡åŸºäºè´¡çŒ®å†…å­˜çš„é«˜é€Ÿè½¯ä»¶æ¥å£åœ¨å®¢æˆ·æœºDomUå’Œæ§åˆ¶åŸŸDom0ä¹‹é—´ä¼ é€’æ•°æ®ã€‚

å…¸å‹çš„åŠè™šæ‹ŸåŒ–è®¾å¤‡å¦‚ç½‘ç»œå’Œå­˜å‚¨ç³»ç»Ÿï¼Œè¿˜æœ‰åŠè™šæ‹ŸåŒ–ä¸­æ–­ã€å®šæ—¶å™¨å’Œé¡µè¡¨ç­‰ç­‰ã€‚

å¦‚æœæƒ³è¦äº†è§£æ›´å¤šå…³äºXené¡¹ç›®ç³»ç»Ÿçš„æ¶æ„ã€åŠè™šæ‹ŸåŒ–ä»¥åŠè¿™æ ·åšçš„å¥½å¤„ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„æ–‡ç« ï¼š

* Details of [Paravirtualization (PV)](https://wiki.xenproject.org/wiki/Paravirtualization_(PV)) and how it is used on Xen Project

å¯¹äºHVMè™šæ‹Ÿæœºï¼ŒDom0ä½¿ç”¨CPUæä¾›çš„ç¡¬ä»¶è™šæ‹ŸåŒ–æ‰©å±•åŠŸèƒ½ã€‚é¦–å…ˆï¼Œå®ç°CPUè‡ªèº«çš„è™šæ‹ŸåŒ–ã€‚ç„¶åï¼Œæ˜¯é¡µè¡¨ç®¡ç†ï¼ˆMMUï¼‰å’ŒI/Oè™šæ‹ŸåŒ–ï¼ˆIOMMUï¼‰ã€‚å¦å¤–ï¼ŒDom0è¿˜å¯ä»¥å€ŸåŠ©QEMUçš„ç»„ä»¶è™šæ‹ŸåŒ–ä¸€äº›ç¡¬ä»¶è®¾å¤‡ã€‚ä½†æ˜¯ï¼Œä½¿ç”¨è½¯ä»¶è¿›è¡Œè®¾å¤‡æ¨¡æ‹Ÿä¼šé™ä½ç³»ç»Ÿæ€§èƒ½ã€‚

# 3 å‡†å¤‡å·¥ä½œ

éœ€è¦æ»¡è¶³ä¸€ä¸‹æ¡ä»¶ï¼š

* è‡³å°‘1Gå†…å­˜çš„64ä½X86è®¡ç®—æœº

* æ”¯æŒV-Tæˆ–AMD-Vï¼ˆå¯¹äºåŠè™šæ‹ŸåŒ–å¯é€‰ï¼Œå¯¹äºå…¨è™šæ‹ŸåŒ–å’ŒæŸäº›åŠè™šæ‹ŸåŒ–ä¼˜åŒ–æ¥è¯´æ˜¯å¿…é¡»çš„ï¼‰

* ä¸ºDom0å’Œå…¶å®ƒå®¢æˆ·æœºæä¾›è¶³å¤Ÿçš„å­˜å‚¨ç©ºé—´

* CD/DVDåˆ»å½•æœºå’Œä¸€å¼ CD/DVDï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨USBï¼Œå¯ä»¥å‚è€ƒå…¶å®ƒèµ„æ–™ï¼‰

* ä¸‹è½½Debianï¼Œå¹¶åˆ»å½•åˆ°CD/DVDä¸­

* å…·æœ‰licenseçš„Windowæˆ–Windows server 2008çš„ISOé•œåƒ

* VNCå®¢æˆ·ç«¯ï¼ˆPVå¯é€‰ï¼ŒHVMå¿…é¡»ï¼‰

> å…³äºVTå’ŒAMD-Vï¼š
> 
> ç¡®è®¤ä¸»æœºæ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–æ‰©å±•æ˜¯å¾ˆé‡è¦çš„ã€‚å¦‚æœä¸»æ¿ä¸æ”¯æŒï¼Œå³ä½¿CPUä½¿èƒ½ç¡¬ä»¶æ‰©å±•ä¹Ÿæ²¡æœ‰ç”¨ã€‚å¦‚æœæƒ³ä½¿ç”¨HVMå®ä¾‹ï¼Œé‚£ä¹ˆåº•å±‚ç¡¬ä»¶è‡³å°‘æ”¯æŒVT-då’ŒVT-iæˆ–AMD-Vå’ŒAMD-Viä¸­çš„ä¸€ç§ã€‚è¯è™½å¦‚æ­¤ï¼Œæœ€ç®€å•çš„æ£€æŸ¥æ–¹æ³•è¿˜æ˜¯é€šè¿‡BIOSè¿›è¡ŒæŸ¥çœ‹ã€‚

## 3.1 BIOSä¸­ä½¿èƒ½è™šæ‹ŸåŒ–æ”¯æŒ

> å¯¹äºåŠè™šæ‹ŸåŒ–å®¢æˆ·æœºæ¥è¯´ï¼Œè¿™ä¸æ˜¯å¿…é¡»çš„ã€‚ä½†æ˜¯ï¼Œå¼€å¯è™šæ‹ŸåŒ–æ”¯æŒåï¼ŒåŠè™šæ‹ŸåŒ–å’Œå…¨è™šæ‹ŸåŒ–ä½ éƒ½å¯ä»¥ä½¿ç”¨äº†ã€‚

å¦‚æœä½ çš„ç³»ç»Ÿä¸æ”¯æŒç¡¬ä»¶è™šæ‹ŸåŒ–æ‰©å±•æ”¯æŒï¼Œé‚£ä¹ˆå°±æ— æ³•ä½¿ç”¨Xenç›‘æ§ç¨‹åºè™šæ‹ŸåŒ–æœªç»ä¿®æ”¹çš„æ“ä½œç³»ç»Ÿã€‚ä½†æ˜¯ï¼ŒåŠè™šæ‹ŸåŒ–çš„å®¢æˆ·æœºå¯ä»¥å·¥ä½œã€‚
ä¸åŒçš„è®¡ç®—æœºï¼ŒBIOSç¨‹åºå¯èƒ½ä¸ä¸€æ ·ã€‚ä½†æ˜¯ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒåŸºäºIntelèŠ¯ç‰‡çš„è®¡ç®—æœºä¼šæœ‰`Enable Intel VT`å­—æ ·ï¼ŒADMèŠ¯ç‰‡ä¼šæœ‰`Enable AMD-V`å­—æ ·ç­‰ã€‚è¿™äº›é€‰é¡¹ä¸€èˆ¬æ˜¯åœ¨BIOSç¨‹åºçš„`Advanced Chipset Features`èœå•ä¸‹ã€‚æœ‰æ—¶å€™ï¼Œé»˜è®¤æ˜¯å¼€å¯çš„ã€‚

## 3.2 ä¸‹è½½å¹¶åˆ»å½•Debianå®‰è£…å…‰ç›˜

ä½ å¯ä»¥åœ¨ä¸‹é¢çš„åœ°å€æ‰¾åˆ°æœ€æ–°çš„Debiançš„ISOé•œåƒ:

[http://cdimage.debian.org/debian-cd/current/amd64/iso-cd/](http://cdimage.debian.org/debian-cd/current/amd64/iso-cd/)

å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œ`netinst`ç‰ˆæœ¬é•œåƒå°±è¶³å¤Ÿäº†ã€‚

ä½¿ç”¨å·¥å…·å°†ISOåˆ»å½•åˆ°å…‰ç›˜ä¸Šã€‚Linuxæœ‰wodimï¼Œwindowsæœ‰è‡ªå¸¦çš„ISOåˆ»å½•åŠŸèƒ½ã€‚

## 3.3 Debianç®€è¦ä»‹ç»

å…³äºDebiançš„ä»‹ç»å¯ä»¥å‚è€ƒå…¶å®ƒèµ„æ–™ã€‚è¿™å„¿åªæä¸€å¥ï¼šä»`Debian3.1`ç‰ˆæœ¬å¼€å§‹ï¼Œä»¥åŠåŒ…å«å¯¹Xençš„æ”¯æŒã€‚

# 4 å®‰è£…Debian

æ’å…¥Debianå…‰ç›˜ï¼Œåœ¨BIOSä¸­ï¼Œé…ç½®CDROMé©±åŠ¨å™¨ä½œä¸ºä½ é»˜è®¤çš„å¼•å¯¼è®¾å¤‡ã€‚

ä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ªé»˜è®¤çš„`Install`é€‰é¡¹ï¼Œç‚¹å‡»å¼€å§‹å®‰è£…ã€‚ç³»ç»Ÿçš„å®‰è£…æ¯”è¾ƒç®€å•ï¼Œç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¡¬ç›˜åˆ†åŒºéƒ¨åˆ†ã€‚

é€‰æ‹©è‡ªå®šä¹‰é€‰é¡¹ï¼Œæˆ‘ä»¬è‡ªå·±é…ç½®å‡ ä¸ªåˆ†åŒºï¼šä¸€ä¸ªç”¨äºbootè¿‡ç¨‹ï¼Œå¦ä¸€ä¸ªç”¨äºswapåˆ†åŒºï¼›æœ€åä¸€ä¸ªåˆ†åŒºè®¾ç½®ä¸ºå®¢æˆ·æœºçš„LVMé€»è¾‘åˆ†åŒºã€‚

1. åˆ›å»º`/boot`åˆ†åŒº

    é€‰æ‹©ç£ç›˜ï¼Œç‚¹å‡»Enterï¼Œè®¾ç½®åˆ†åŒºå¤§å°ä¸º300MBï¼Œå¹¶æ ¼å¼åŒ–ä¸ºext2ï¼Œé€‰æ‹©bootä½œä¸ºæŒ‚è½½ç‚¹ã€‚

2. åˆ›å»º`/`åˆ†åŒº

    é€‰æ‹©`/`ä½œä¸ºæŒ‚è½½ç‚¹ï¼Œå¤§å°è‡³å°‘ä¸º15GBä»¥ä¸Šï¼Œæ ¼å¼åŒ–ä¸ºext3ã€‚

3. åˆ›å»º`/swap`åˆ†åŒº

    è®¾ç½®å¤§å°ä¸ºRAMçš„1.5å€ï¼Œé€‰æ‹©å®ƒä½œä¸ºäº¤æ¢åŒºã€‚

4. åˆ›å»ºä¿ç•™åˆ†åŒº

    è¯¥åˆ†åŒºæ˜¯ä¸ºå®¢æˆ·æœºçš„LVMé€»è¾‘åˆ†åŒºä¿ç•™çš„ã€‚å¤§å°æ ¹æ®åé¢å¯èƒ½çš„å®¢æˆ·æœºé¢„ç•™ã€‚ä½†æ˜¯ä¸è¦æ ¼å¼åŒ–ï¼Œä¹Ÿä¸è¦æŒ‡å®šæŒ‚è½½ç‚¹ã€‚

åˆ†åŒºåˆ›å»ºå®Œæˆåï¼Œå¤§æ¦‚çš„å¸ƒå±€å¦‚ä¸‹ï¼š

    sda1 - /boot 300MB
    sda2 - / 15GB
    sda3 - swap
    sda4 - reserved for LVM

åªå®‰è£…åŸºæœ¬çš„ç³»ç»Ÿï¼Œä¸è¦GUIæˆ–è€…å…¶å®ƒè½¯ä»¶ã€‚ï¼ˆå¦‚æœæƒ³è¦åœ¨Dom0ä¸­è®¾ç½®å›¾å½¢åŒ–æ¡Œé¢ç¯å¢ƒï¼Œè¿™ä¸æ˜¯é—®é¢˜ã€‚ä½†æ˜¯æœ¬æ‰‹å†Œä¸ºäº†ç®€å•èµ·è§ï¼Œå°½é‡ç¼©å‡äº†åŠŸèƒ½ï¼‰ã€‚

æ‚¨å¯ä»¥ä»Debianæ–‡æ¡£ä¸­æ‰¾åˆ°Debianå®‰è£…è¿‡ç¨‹çš„è¯¦ç»†ä¿¡æ¯ã€‚

ç»§ç»­æ‰§è¡Œå®‰è£…ç¨‹åºï¼Œç„¶åé‡æ–°å¯åŠ¨ï¼Œå¹¶åœ¨æç¤ºç¬¦ä¸‹ä»¥rootç”¨æˆ·èº«ä»½ç™»å½•ã€‚

# 5 å®‰è£…Xen

Debianä¸‹çš„Xené¡¹ç›®åŒ…å«ï¼šæ”¯æŒXençš„Linuxå†…æ ¸ï¼Œç›‘æ§ç¨‹åºæœ¬èº«ï¼Œæ”¯æŒç›‘æ§ç¨‹åºHVMæ¨¡å¼çš„ä¿®æ”¹ç‰ˆQEMUï¼Œå’Œä¸€ç»„ç”¨æˆ·å·¥å…·ã€‚æ‰€æœ‰è¿™äº›éƒ½åŒ…å«åœ¨ä¸€ä¸ªç§°ä¸º`xen-linux-system`çš„å…ƒè½¯ä»¶åŒ…ï¼Œä½¿ç”¨APTè½¯ä»¶åŒ…ç®¡ç†æ–¹å¼è¿›è¡Œå®‰è£…ã€‚

å®‰è£…`xen-linux-system`å…ƒè½¯ä»¶åŒ…ï¼š

    apt-get install xen-system-amd64

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†Xenç›‘æ§ç¨‹åºï¼Œå†…æ ¸å’Œç”¨æˆ·å·¥å…·ã€‚å½“ä½ å†æ¬¡å¯åŠ¨ç³»ç»Ÿçš„æ—¶å€™ï¼Œå¯åŠ¨èœå•ä¸­ä¼šæœ‰å¯åŠ¨å¸¦æœ‰Xenç›‘æ§ç¨‹åºçš„Debiané€‰é¡¹ï¼ˆé»˜è®¤ï¼‰ã€‚å†æ¬¡ä»¥rootèº«ä»½é‡å¯ã€‚

æ¥ä¸‹æ¥ï¼Œæ£€æŸ¥BIOSä¸­æ˜¯å¦å°†è™šæ‹ŸåŒ–åŠŸèƒ½æ‰“å¼€ã€‚æœ‰å¤šç§æ–¹å¼ï¼š

æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯æŸ¥çœ‹å¯åŠ¨è¿‡ç¨‹çš„dmesgä¿¡æ¯ä¸­Xenç›¸å…³å†…å®¹ã€‚è‡³äº`xl`å‘½ä»¤åé¢ä¼šå†è®²ï¼š

    xl dmesg

è¾“å‡ºä¸­ä¼šåŒ…å«å¯¹BIOSä¸­è®¾ç½®çš„å¯åŠ¨è™šæ‹ŸåŒ–çš„ç›¸å…³æ ‡å¿—ï¼š`vmx`ä¹‹äºIntelï¼Œ`svm`ä¹‹äºAMDã€‚è¿˜ä¼šæ˜¾ç¤ºä¸€äº›å…¶å®ƒå…³äºè™šæ‹ŸåŒ–æ‰©å±•çš„å†…å®¹ã€‚

å¦å¤–ä¸€ç§æ–¹æ³•ï¼ŒæŸ¥çœ‹cpuç›¸å…³ä¿¡æ¯ï¼š

    egrep '(vmx|svm|hypervisor)' /proc/cpuinfo

æˆ–è€…å…¨éƒ¨æ‰“å°å‡ºæ¥ï¼Œè‡ªå·±æŸ¥çœ‹ç›¸å…³ä¿¡æ¯ï¼š

    cat /proc/cpuinfo

è‡³äº`egrep`å‘½ä»¤ï¼Œè¯·è‡ªè¡ŒæŸ¥é˜…ç›¸å…³shellä¹¦ç±ã€‚

# 6 ä¸ºè™šæ‹Ÿæœºå»ºç«‹LVMå­˜å‚¨

## 6.1 LVMæ¦‚å¿µ

LVMæ˜¯Linuxé€»è¾‘å·ç®¡ç†å™¨ï¼Œå…è®¸Linuxä»¥æ›´ä¸ºæŠ½è±¡çš„æ–¹æ³•ç®¡ç†å—è®¾å¤‡ã€‚ LVMå¼•å…¥äº†`é€»è¾‘å·`çš„æ¦‚å¿µï¼Œæœ‰æ•ˆåœ°å…è®¸ä¸€ä¸ªè™šæ‹Ÿçš„å—è®¾å¤‡ï¼ˆå…·æœ‰å¤šä¸ªå—ï¼‰å¯ä»¥å†™å…¥åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªç‰©ç†è®¾å¤‡ä¸­ã€‚ä¸çœŸæ­£çš„ç¡¬ç›˜åˆ†åŒºä¸åŒï¼Œè¿™äº›å—ä¸éœ€è¦æ˜¯è¿ç»­çš„ã€‚è¿™ç§æŠ½è±¡çš„é€»è¾‘å·å¯ä»¥åœ¨ä¸å½±å“å…¶å®ƒé€»è¾‘å·çš„æƒ…å†µä¸‹è¢«åˆ›å»ºã€åˆ é™¤ã€è°ƒæ•´å¤§å°ã€ç”šè‡³æ˜¯å¿«ç…§åŠŸèƒ½ã€‚

LVMåœ¨æ‰€è°“çš„å·ç»„ä¸­åˆ›å»ºé€»è¾‘å·ï¼Œå·ç»„åªæ˜¯å…±äº«ç›¸åŒç‰©ç†å­˜å‚¨çš„ä¸€ç»„é€»è¾‘å·ï¼Œç§°ä¸ºç‰©ç†å·ã€‚åˆ›å»ºLVMçš„è¿‡ç¨‹æ¦‚æ‹¬èµ·æ¥å°±æ˜¯ï¼Œç”³è¯·åˆ†é…ä¸€ä¸ªç‰©ç†å·ï¼Œåœ¨æ­¤ä¹‹ä¸Šåˆ›å»ºå·ç»„ï¼Œç„¶ååˆ›å»ºé€»è¾‘å·å­˜å‚¨æ•°æ®ã€‚

> <font color="blue"> 
> æ€»ç»“ï¼š
> 
> LVMå…¶å®å°±æ˜¯å±è”½ç¡¬ä»¶å—è®¾å¤‡çš„å·®å¼‚ï¼Œå¯¹äºä¸Šå±‚çš„åº”ç”¨æ¥è¯´ï¼Œå°±æ˜¯ä¸€ä¸ªå¯ä»¥è‡ªç”±ä½¿ç”¨çš„è™šæ‹Ÿç¡¬ä»¶è®¾å¤‡ã€‚
> 
> </font>

ç”±äºå…¶ç‰¹æ€§å’Œç”±äºæ–‡ä»¶æ”¯æŒçš„è™šæ‹Ÿæœºï¼Œå¦‚æœæƒ³è¦å­˜å‚¨è™šæ‹Ÿæœºæ•°æ®ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨LVMã€‚

## 6.2 å®‰è£…LVM

å®‰è£…LVMï¼š

    apt-get install lvm2

é…ç½®LVMä½¿ç”¨`/dev/sda4`ä½œä¸ºç‰©ç†å·ï¼š

    pvcreate /dev/sda4

OKï¼Œç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªç‰©ç†å·åˆ›å»ºä¸€ä¸ªå·ç»„`vg0`ï¼š

    vgcreate vg0 /dev/sda4

ç°åœ¨ï¼ŒLVMå·²ç»å»ºç«‹å¹¶è¢«åˆå§‹åŒ–ã€‚åé¢æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒï¼Œä¸ºæˆ‘ä»¬çš„è™šæ‹Ÿæœºåˆ›å»ºé€»è¾‘å·ã€‚

> ä¸‹é¢æ˜¯ä¸€äº›ä½¿ç”¨LVMçš„æœ‰ç”¨å‘½ä»¤å’Œå°æŠ€å·§ï¼š
>
> 1. åˆ›å»ºä¸€ä¸ªæ–°çš„é€»è¾‘å·ï¼š
>
>       lvcreate -n [é€»è¾‘å·åç§°] -L [å¤§å°(å¯ä»¥ä½¿ç”¨Gå’ŒMè¡¨ç¤ºå¤§å°)]  [å·ç»„]
>
> æ¯”å¦‚ï¼Œåœ¨å·ç»„`vg0`ä¸Šåˆ›å»ºä¸€ä¸ªç§°ä¸º`database-data`çš„100Gå¤§å°çš„å·ï¼š
>
>       lvcreate -n database-data -L 100G vg0
>
> 2. ç§»é™¤é€»è¾‘å·ï¼š
>
>       lvremove /dev/vg0/database-data     # æ³¨æ„å¿…é¡»ä½¿ç”¨æ­£ç¡®è·¯å¾„
>
> æ›´å¤šå…³äºDebianä¸Šä½¿ç”¨LVMçš„æ–¹æ³•ï¼Œè¯·å‚è€ƒ [More on LVM on Debian here.](https://wiki.debian.org/LVM#List_of_VG_commands)
>
> å¦‚æœä½ å·²ç»æœ‰ä¸€ä¸ªé€»è¾‘å·äº†ï¼Œæƒ³è¦å¯¹å…¶è¿›è¡Œæ‹·è´ï¼ŒLVMæœ‰ä¸€ä¸ªå¾ˆé…·çš„åŠŸèƒ½ï¼Œå…è®¸`å†™æ—¶æ‹·è´-COW`å…‹éš†ï¼Œç§°ä¸º`å¿«ç…§`åŠŸèƒ½ã€‚è¿™æ„å‘³ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªå³æ—¶å‰¯æœ¬ï¼Œå®ƒå°†åªå­˜å‚¨ä¸åŸå§‹å·ç›¸æ¯”ä½œå‡ºçš„æ›´æ”¹éƒ¨åˆ†ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€äº›æ³¨æ„äº‹é¡¹ï¼Œæˆ‘ä»¬å°†åœ¨å…¶å®ƒæ–‡ç« ä¸­è®¨è®ºã€‚è¿˜æœ‰ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„äº‹æƒ…å°±æ˜¯ï¼Œ`å¿«ç…§`çš„å¤§å°åªæ˜¯å­˜å‚¨å˜åŒ–å†…å®¹çš„ç©ºé—´å¤§å°ï¼Œæ‰€ä»¥ï¼Œå¿«ç…§çš„å¤§å°æ¯”åŸå§‹å·çš„è¦å°å¾ˆå¤šã€‚
>
> åˆ›å»ºå¿«ç…§ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š
>
>       lvcreate -s /dev/vg0/database-data -ndatabase-backup -L5G
>
> æ³¨æ„ï¼Œä½¿ç”¨å…¨è·¯å¾„ã€‚

# 7 ä¸ºè™šæ‹Ÿæœºè®¾ç½®Linuxç½‘æ¡¥

ç°åœ¨éœ€è¦ä¸ºè™šæ‹Ÿæœºé…ç½®ç½‘ç»œã€‚è¿™å¯ä»¥åœ¨Dom0ä¸­åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿäº¤æ¢æœºå®ç°ã€‚è¯¥äº¤æ¢æœºä»è™šæ‹Ÿæœºæ¥æ”¶æ•°æ®åŒ…ï¼Œè½¬å‘ç»™ç‰©ç†ç½‘ç»œè®¾å¤‡ã€‚

è¿™å¯ä»¥ä½¿ç”¨Linuxç½‘æ¡¥è®¾å¤‡å®ç°ï¼Œå®ƒçš„æ ¸å¿ƒç»„ä»¶å­˜åœ¨äºLinuxå†…æ ¸ä¸­ã€‚è¿™æ—¶å€™ï¼Œç½‘æ¡¥çš„è§’è‰²å°±æ˜¯æˆ‘ä»¬çš„è™šæ‹Ÿäº¤æ¢æœºã€‚Debianå†…æ ¸æ”¯æŒLinuxç½‘æ¡¥æ¨¡å—ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦å®‰è£…æ§åˆ¶ç®¡ç†å·¥å…·å³å¯ï¼š

    apt-get install bridge-utils

ç½‘æ¡¥çš„ç®¡ç†å¯ä»¥ä½¿ç”¨`brctl`å‘½ä»¤ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•è¿›è¡Œç½‘ç»œçš„é…ç½®ã€‚

æ‰“å¼€æ–‡ä»¶ã€‚ï¼ˆå¦‚æœæ²¡æœ‰nanoï¼Œå¯ä»¥å®‰è£…ï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶å®ƒç¼–è¾‘å™¨ï¼‰

    nano /etc/network/interfaces

ä½ å¯ä»¥çœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„å†…å®¹ï¼š

    auto lo
    iface lo inet loopback

    auto eth0
    iface eth0 inet dhcp

`auto eth0`çš„æ„æ€æ˜¯ï¼Œå¦‚æœè¿è¡Œ`ifup -a`ï¼Œå°±ä¼šé…ç½®eth0ï¼ˆè¿™å‘ç”Ÿåœ¨ç³»ç»Ÿå¯åŠ¨é˜¶æ®µï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç³»ç»Ÿè‡ªåŠ¨å¯åœè¿™ä¸ªç½‘ç»œæ¥å£ï¼Œä¸éœ€è¦å’±ä»¬å¹²é¢„ã€‚eth0æ˜¯ä¸€ä¸ªå¸¸è§åç§°ï¼Œä¹Ÿå¯èƒ½æ˜¯`ens1`ã€`enp0s3`ä¹‹ç±»çš„ã€‚

`iface eth0`å°±æ˜¯æè¿°æ¥å£æœ¬èº«çš„å±æ€§ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œé…ç½®ä½¿ç”¨DHCPæ–¹å¼ã€‚ä¹Ÿå°±æ˜¯ä½¿ç”¨åŠ¨æ€IPçš„æ–¹å¼ã€‚

ä¿®æ”¹å¦‚ä¸‹ï¼š

    auto lo
    iface lo inet loopback

    auto eth0
    iface eth0 inet manual
    
    auto xenbr0
    iface xenbr0 inet dhcp
         bridge_ports eth0

ä¸Šé¢çš„è®¾ç½®æ˜¯ï¼Œå°†IPæŒ‡å®šç»™ç½‘æ¡¥è¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯ç½‘ç»œæ¥å£ã€‚ç½‘ç»œæ¥å£åªæä¾›ç‰©ç†å’Œæ•°æ®é“¾è·¯å±‚çš„åŠŸèƒ½ã€‚

é‡å¯ç½‘ç»œã€‚

    service networking restart

æ£€æŸ¥æ˜¯å¦å·¥ä½œï¼š

    brctl show

å¦‚æœå¯ä»¥ï¼Œç½‘æ¡¥ä¼šè¢«åˆ—å‡ºï¼Œç½‘ç»œæ¥å£ä¹Ÿä¼šå‡ºç°ï¼š

    bridge name     bridge id               STP enabled     interfaces
    xenbr0          8000.4ccc6ad1847d       no              enp2s0

è‡³æ­¤ï¼Œæ¡¥æ¥ç½‘ç»œåœ¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨å¯åŠ¨ã€‚

# 8 é…ç½®GRUBå¯åŠ¨Xen 

GRUBï¼Œæ˜¯ä¸€ä¸ªå¼•å¯¼ç¨‹åºã€‚ä¸ºäº†ä½¿ç”¨ç›‘æ§ç¨‹åºXenï¼Œå¿…é¡»åœ¨æ“ä½œç³»ç»Ÿä¹‹å‰å¯åŠ¨Xenã€‚æ ¹æ®ä½ çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦é»˜è®¤åŠ è½½Xenã€‚

GRUB2çš„é…ç½®ä½äº`/boot/grub/grub.cfg`æ–‡ä»¶ä¸­ã€‚

æˆ‘ä»¬ä¸ä¼šç›´æ¥ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶ï¼Œå› ä¸ºæ¯å½“æˆ‘ä»¬æ›´æ–°å†…æ ¸çš„æ—¶å€™ï¼Œå®ƒéƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚Debianä¸ºäº†æ–¹ä¾¿ï¼Œæä¾›äº†è®¸å¤šè‡ªåŠ¨æ›´æ–°è„šæœ¬ï¼Œä½äº`/etc/grub.d/*`ç›®å½•ä¸‹ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–‡ä»¶è¿›è¡Œé…ç½®ï¼š

    /etc/default/grub

ä¸ºäº†æ”¹å˜é»˜è®¤æ“ä½œç³»ç»Ÿï¼Œå°†ä¸‹é¢çš„å€¼æ”¹ä¸º0ï¼ˆå¦‚æœæ²¡æœ‰æ”¹è¡Œï¼Œè¯·åœ¨æ–‡ä»¶ä¸­æ·»åŠ ï¼‰ï¼š

    GRUB_DEFAULT=0

ä¸Šé¢çš„ä»£ç æ˜¯å°†åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªæ“ä½œç³»ç»Ÿä½œä¸ºé»˜è®¤å€¼ï¼Œä»¥æ­¤ç±»æ¨ã€‚å¦‚æœXenæ˜¯ç¬¬ä¸‰ç§æ“ä½œç³»ç»Ÿï¼Œåˆ™å°†å…¶æ”¹ä¸ºï¼š

    GRUB_DEFAULT=2

é»˜è®¤æƒ…å†µä¸‹å°±ä¼šåŠ è½½Xenã€‚

è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œé‡æ–°äº§ç”Ÿ`/boot/grub/grub.cfg`æ–‡ä»¶ï¼š

    update-grub

ä¸‹ä¸€æ¬¡é‡å¯çš„æ—¶å€™ï¼Œçœ‹æ˜¯å¦é€‰æ‹©äº†æ­£ç¡®çš„æ“ä½œç³»ç»Ÿã€‚

# 9 åŸºæœ¬çš„Xenå‘½ä»¤

ä¿—è¯è¯´ï¼Œ"ç£¨åˆ€ä¸è¯¯ç æŸ´å·¥"ã€‚ä¸‹é¢æˆ‘ä»¬å…ˆæ¥ç†Ÿæ‚‰å‡ ä¸ª`xl`å‘½ä»¤è¡Œå·¥å…·ï¼ˆæ—§ç‰ˆæœ¬çš„Xenè½¯ä»¶ä½¿ç”¨`xm`å‘½ä»¤è¡Œå·¥å…·ï¼‰ã€‚å…¶å®ï¼Œ`xl`å’Œ`xm`å‘½ä»¤è¡Œæ ¼å¼å·®ä¸å¤šï¼ˆå¯èƒ½è¾“å‡ºæ ¼å¼ä¼šæœ‰è½»å¾®çš„ä¸åŒï¼‰ã€‚å¦‚æœåœ¨é˜…è¯»æ—§æ–‡æ¡£çš„æ—¶å€™ï¼Œç¢°è§`xm`ï¼Œæ›¿æ¢ä¸º`xl`å³å¯ã€‚

è®©æˆ‘ä»¬æ“ç»ƒèµ·æ¥å§ï¼ğŸ˜Š

    xl info

æ— éå°±æ˜¯è¿”å›Xenç›‘æ§ç¨‹åºã€Dom0ä»¥åŠå¯ä»¥ä½¿ç”¨çš„å†…å­˜ç­‰ä¿¡æ¯ã€‚

    xl list

åˆ—å‡ºè¿è¡Œçš„DomXï¼Œå®ƒä»¬çš„IDï¼Œå†…å­˜ï¼ŒçŠ¶æ€ä»¥åŠå ç”¨çš„CPUè¿è¡Œæ—¶é—´ã€‚

    xl top

å®æ—¶æ˜¾ç¤ºæ­£åœ¨è¿è¡Œçš„DomåŸŸï¼Œä¸Linuxä¸‹çš„`top`å‘½ä»¤æœ‰ç‚¹ç±»ä¼¼ã€‚è¿™å¯ä»¥ç”¨æ¥æŸ¥çœ‹CPUï¼Œå†…å­˜ä½¿ç”¨ç‡ä»¥åŠå—è®¾å¤‡çš„è®¿é—®æƒ…å†µã€‚åé¢åˆ›å»ºè™šæ‹Ÿæœºçš„è¿‡ç¨‹ä¸­ï¼Œè¿˜ä¼šç»§ç»­ç†Ÿæ‚‰å…¶å®ƒå‘½ä»¤ã€‚

æƒ³è¦æŸ¥çœ‹æ›´å¤šçš„å‘½ä»¤å†…å®¹ï¼Œè¯·å‚è€ƒ [Xen Project 4.x Man Pages](https://wiki.xenproject.org/wiki/Xen_4.x_Manuals)ã€‚

# 10 åˆ›å»ºä¸€ä¸ªåŠè™šæ‹ŸåŒ–çš„Debianè™šæ‹Ÿæœº

åŠè™šæ‹ŸåŒ–çš„å®¢æˆ·æœºå®‰è£…è‚¯å®šä¸åŒã€‚å¹¸è¿çš„æ˜¯ï¼Œæœ‰è®¸å¤šå·¥å…·å¸®åŠ©æˆ‘ä»¬å‡†å¤‡å¯ä»¥è¿è¡Œåœ¨å®¢æˆ·åŸŸä¸­è¿è¡Œçš„æ“ä½œç³»ç»Ÿé•œåƒã€‚

Debianä¸‹æœ‰è®¸å¤šåˆ›å»ºXenå®¢æˆ·æœºçš„è¾…åŠ©å·¥å…·ï¼Œæœ€ç®€å•çš„å°±æ˜¯`xen-tools`ã€‚è¿™ä¸ªå·¥å…·ç®¡ç†å®¢æˆ·æ“ä½œç³»ç»Ÿçš„ä¸‹è½½å’Œå®‰è£…ï¼ŒåŒ…æ‹¬åŸºäºDebianå’ŒRHELçš„DomUã€‚åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`xen-tools`å‡†å¤‡ä¸€ä¸ªDebianåŠè™šæ‹ŸåŒ–çš„DomUã€‚

`xen-tools`å¯ä»¥ä½¿ç”¨LVMå­˜å‚¨å®¢æˆ·æ“ä½œç³»ç»Ÿã€‚åœ¨å‰é¢ï¼Œæˆ‘ä»¬å·²ç»åˆ›å»ºå·ç»„`vg0`ã€‚

å®¢æˆ·æ“ä½œç³»ç»ŸåŠè™šæ‹ŸåŒ–çš„æ„æ€å°±æ˜¯ï¼Œæ²¡æœ‰ç±»ä¼¼äº`BIOS`æˆ–`bootloader`å­˜åœ¨äºå®¢æˆ·æœºçš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚ä½†æ˜¯ï¼Œè¿™ä¸åˆ©äºå¯ç»´æŠ¤æ€§ï¼ˆå¦‚æœä¸èƒ½è®¿é—®Dom0ï¼Œå®¢æˆ·æœºæ— æ³•æ›´æ–°å®ƒä»¬çš„å†…æ ¸ï¼‰ï¼Œè€Œä¸”åœ¨å¼•å¯¼æ–¹é¢ï¼Œä¹Ÿä¸å¦‚ä½¿ç”¨é…ç½®æ–‡ä»¶ä¼ é€’é‚£æ ·çµæ´»æ–¹ä¾¿ã€‚

Xenç¤¾åŒºå†™äº†ä¸€ä¸ªå·¥å…·ï¼Œç§°ä¸º`pygrub`ï¼ˆä½¿ç”¨pythonç¼–å†™ï¼‰ï¼Œè¾…åŠ©åŠè™šæ‹ŸåŒ–å®¢æˆ·æœºä½¿èƒ½Dom0ï¼Œå»è§£æDomUçš„grubé…ç½®ï¼Œå¹¶æå–å…¶å†…æ ¸ã€initrdå’Œå¼•å¯¼å‚æ•°ã€‚è¿™å…è®¸åœ¨æˆ‘ä»¬çš„å®¢æˆ·æœºå†…éƒ¨å®ç°ä½¿ç”¨GRUBèœå•æ›´æ–°å†…æ ¸ã€‚ä½¿ç”¨`pygrub`æˆ–ç§°ä¸º`PV -grub`çš„`stub-dom`å®ç°æ˜¯å¯åŠ¨PVå®¢æˆ·æœºçš„æœ€ä½³å®è·µã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ`pv-grub`å¯èƒ½æ›´å®‰å…¨ï¼Œä½†ç”±äºDebianä¸­æ²¡æœ‰åŒ…å«å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œä¸ä½¿ç”¨å®ƒï¼Œä½†å»ºè®®åœ¨ä¸ä¿¡ä»»å®¢æˆ·æœºçš„ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å®ƒã€‚

é™¤æ­¤ä¹‹å¤–ï¼ŒPVå®¢æˆ·æœºä¸å¯¹åº”çš„HVMå’Œç‰©ç†OSéå¸¸ç›¸ä¼¼ã€‚

## 10.1 é…ç½®`xen-tools`å¹¶æ„å»ºå®¢æˆ·æœº

é¦–å…ˆï¼Œå®‰è£…`xen-tools`è½¯ä»¶åŒ…ï¼š

    apt-get install xen-tools

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºè‡ªå·±çš„å®¢æˆ·æ“ä½œç³»ç»Ÿäº†ã€‚ä¸‹é¢æ˜¯ä»å¤´å»ºç«‹ä¸€ä¸ªPVå®¢æˆ·æœºï¼Œåˆ°åˆ›å»ºé…ç½®æ–‡ä»¶å¹¶å¯åŠ¨å®¢æˆ·æœºçš„è¿‡ç¨‹ï¼š

1. ä¸º`rootfs`åˆ›å»ºé€»è¾‘å·

2. ä¸º`swap`åˆ›å»ºé€»è¾‘å·

3. ä¸º`rootfs`åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ

4. æŒ‚è½½`rootfs`

5. ä½¿ç”¨`debootstrap`å®‰è£…æ“ä½œç³»ç»Ÿï¼ˆæˆ–è€…`rinse`ï¼‰

6. è¿è¡Œä¸€ç³»åˆ—è„šæœ¬ï¼Œäº§ç”Ÿå®¢æˆ·æœºé…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚`fstab/inittab/menu.lst`

7. ä¸ºå®¢æˆ·æœºåˆ›å»ºVMé…ç½®æ–‡ä»¶

8. ä¸ºå®¢æˆ·æœºç³»ç»Ÿäº§ç”Ÿä¸€ä¸ªrootå¯†ç 

9. å¸è½½å®¢æˆ·æœºæ–‡ä»¶ç³»ç»Ÿ

è¿™9æ­¥å¯ä»¥æ‰‹åŠ¨æ‰§è¡Œï¼Œä½†æ˜¯æœ¬æŒ‡å—ä¸è®²æ‰‹åŠ¨å®ç°ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è‡ªåŠ¨åˆ›å»ºï¼ˆå¯¹äº`--dist`é€‰é¡¹ï¼Œå¯ä»¥ä½¿ç”¨å…¶å®ƒï¼Œæ¯”å¦‚`Squeeze`ã€ç”šè‡³æ˜¯Ubuntuçš„`Precise`æˆ–`Quantal`è¿›è¡Œæ›¿ä»£ï¼‰ã€‚

    xen-create-image --hostname=tutorial-pv-guest \
    --memory=512mb \
    --vcpus=2 \
    --lvm=vg0 \
    --dhcp \
    --pygrub \
    --dist=jessie
    --mirror=https://mirrors.tuna.tsinghua.edu.cn/debian/

> å› ä¸ºæˆ‘åœ¨å®‰è£…çš„æ—¶å€™é€‰æ‹©äº†æ¸…åçš„é•œåƒæœåŠ¡å™¨ï¼Œæ‰€ä»¥éœ€è¦åœ¨ä¸Šé¢ä¿®æ”¹mirrorè·¯å¾„ã€‚é»˜è®¤ä½¿ç”¨`http://deb.debian.org/debian/`ã€‚

è¿™ä¸ªå‘½ä»¤æŒ‡ç¤º`xen-create-image`ï¼ˆ`xen-tools`å·¥å…·é“¾ä¸­çš„ä¸»è¦äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰åˆ›å»ºä¸€ä¸ªå…·æœ‰512Må†…å­˜ã€2ä¸ªvcpuã€ä½¿ç”¨`vg0`é€»è¾‘å·ã€ç½‘ç»œä½¿ç”¨DHCPã€åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä½¿ç”¨`pygrub`ä»é•œåƒä¸­æŠ½å–å†…æ ¸ã€æœ€åæŒ‡å®šæˆ‘ä»¬æƒ³è¦éƒ¨ç½²ä¸€ä¸ªDebiançš„`Wheezy`æ“ä½œç³»ç»Ÿã€‚

è¿™ä¸ªè¿‡ç¨‹ä¼šèŠ±è´¹å‡ åˆ†é’Ÿã€‚ä¸€æ—¦å®Œæˆï¼Œä¼šæ˜¾ç¤ºä¸€äº›å®‰è£…çš„æ¦‚è¦ä¿¡æ¯ã€‚è¯·è®°ä½å®¢æˆ·æœºçš„rootå¯†ç <root_password: MQ2jKJqxBMfZvJ7ZLzBXgQe>ã€‚

æ›´å¤šå†…å®¹è¯·å‚è€ƒä¸‹é¢è¿™ä¸¤ç¯‡æ–‡ç« ï¼š

1. [xen-create-image(8) man page](http://manpages.debian.org/cgi-bin/man.cgi?query=xen-create-image&apropos=0&sektion=0&manpath=Debian+6.0+squeeze&format=html&locale=en)
2. [Further articles on xen-tools](https://wiki.xenproject.org/wiki/Xen-tools)

# 11 æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªPVå®¢æˆ·æœº

å¹¶ä¸æ˜¯æ¯ä¸ªå‘è¡Œç‰ˆéƒ½æä¾›ç”¨äºè‡ªåŠ¨åˆ›å»ºå’Œé…ç½®PVå®¢æˆ·æœºçš„`xen-tools`è½¯ä»¶åŒ…ï¼Œå¹¶ä¸”æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å¯¹å®¢æˆ·æœºçš„å»ºç«‹è¿‡ç¨‹æœ‰æ›´å¤šçš„æ§åˆ¶ã€‚

`Alpine Linux`å°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªå‘è¡Œç‰ˆæœ¬ã€‚å…·ä½“å‚è€ƒ[on installing and starting a PV domU manually](http://wiki.alpinelinux.org/wiki/Create_Alpine_Linux_PV_DomU)ã€‚å…¶ä¸­ï¼Œå®ƒä½¿ç”¨çš„æ˜¯`PVGRUB2`è€Œä¸æ˜¯`pygrub`ã€‚

# 12 å¯åŠ¨å®¢æˆ·æœºï¼ˆæ§åˆ¶å°ï¼‰

è¿è¡Œä¸‹é¢çš„å‘½ä»¤å¯åŠ¨å®¢æˆ·æœºï¼š

    xl create -c /etc/xen/tutorial-pv-guest.cfg

`-c`é€‰é¡¹æ˜¯å‘Šè¯‰`xl`ï¼Œæˆ‘ä»¬æƒ³è¦è¿æ¥å®¢æˆ·æœºè™šæ‹Ÿæ§åˆ¶å°ï¼Œæ˜¯å®¢æˆ·åŸŸä¸­çš„ä¸€ä¸ªåŠè™šæ‹ŸåŒ–ä¸²å£ç«¯å£ï¼Œ`xen-create-image`é…ç½®ä¸ºä½¿ç”¨gettyä¾¦å¬ã€‚ä¸ä¸‹é¢çš„å‘½ä»¤æ•ˆæœä¸€æ ·ã€‚

    xl create /etc/xen/tutorial-pv-guest.cfg && xl console tutorial-pv-guest

ç¦»å¼€å®¢æˆ·æœºè™šæ‹Ÿæ§åˆ¶å°çš„å‘½ä»¤æ˜¯`ctrl+]`ï¼Œé‡æ–°è¿›å…¥çš„å‘½ä»¤æ˜¯`xl console <domain>`ã€‚

å…³é—­å®¢æˆ·æœºçš„å‘½ä»¤ï¼Œå¦‚ä¸‹ï¼ˆä»DomUæˆ–è€…Dom0éƒ½å¯ä»¥ï¼‰ï¼š

    xl shutdown tutorial-pv-guest

è‡³æ­¤ï¼Œæˆ‘ä»¬å»ºç«‹äº†ç¬¬ä¸€ä¸ªåŠè™šæ‹ŸåŒ–çš„DomåŸŸã€‚å¦‚æœä½ å¯¹å»ºç«‹ä¸€ä¸ªå…¨è™šæ‹ŸåŒ–DomåŸŸä¸æ„Ÿå…´è¶£ï¼Œè¯·è·³è¿‡ä¸‹é¢çš„ä¸€ç« ï¼Œç›´æ¥é˜…è¯»[14. å¯åŠ¨ä¸€ä¸ªGUIå®¢æˆ·æœº](#14)

<img src="https://raw.githubusercontent.com/tupelo-shen/my_test/master/doc/AI_ML/Edge%20computing/XEN/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/images/Xen_beginner_guide_3.png">

# 13 åˆ›å»ºä¸€ä¸ªWindowså…¨è™šæ‹ŸåŒ–å®¢æˆ·æœº

HVM guests are quite a bit different to their PV counterparts. Because they require the emulation of hardware there are more moving pieces that need to be configured etc.

The main point worth mentioning here is that HVM requires the emulation of ATA, Ethernet and other devices, while virtualized CPU and Memory access is performed in hardware to achieve good performance. Because of this the default emulated devices are very slow and we generally try to use PV drivers within HVM domains. We will be installing a set of Windows PV drivers that greatly increase performance once we have our Windows guest running.

This extra emulation is provided by QEMU which will have been installed along with the Xen software.

To set up the HVM domU, we need to create a logical volume to store our Windows VM hard disk, create a config file that tells the hypervisor to start the domain in HVM mode and boot from the DVD in order to install Windows.

First, create the new logical volume - name the volume "windows", set the size to 20GB and use the volume group vg0 we created earlier.

    lvcreate -nwindows -L20G vg0

Next open a new file with your text editor of choice:

    nano windows.cfg

Paste the config below into the file and save it, NOTE this assumes your Windows iso is located in /root/ with the filename windows.iso. In the kernel = line below, be sure the xen version number matches your installation (e.g. xen-4.11, not 4.0):

    kernel = "/usr/lib/xen-4.0/boot/hvmloader"
    type='hvm'
    memory = 4096
    vcpus=4
    name = "ovm-1734"
    vif = ['bridge=xenbr0']
    disk = ['phy:/dev/vg0/windows,hda,w','file:/root/windows.iso,hdc:cdrom,r']
    acpi = 1
    device_model_version = 'qemu-xen'
    boot="d"
    sdl=0
    serial='pty'
    vnc=1
    vnclisten=""
    vncpasswd=""

The vnclisten= line specifies valid VNC connection addresses. vnclisten="127.0.0.1" will limit connections to the local machine. vnclisten="0.0.0.0" will accept unauthenticated remote connections from anywhere so is not suitable except in a secure network.

Start the guest as described below in Starting a GUI guest and proceed with Windows' installation.

Once you have installed Windows by formatting the disk and by following the prompts the domain will restart - however this time we want to prevent it booting from DVD so destroy the domain with

    xl destroy windows

Then change the boot line in the config file to read boot="c"' restart the domain with

    xl create windows.cfg

Reconnect with VNC and finish the installation. When this process is complete you should then proceed to download the GPLPV drivers for Windows by James Harper.

## 13.1 Installing PV drivers for HVM guests

Signed drivers can be obtained from [Univention's website](http://wiki.univention.de/index.php?title=Installing-signed-GPLPV-drivers).

Many thanks for Univention for making signed drivers available to the Xen Project community and of course a massive thanks to James for all his work on making Windows in guest VMs such a smooth experience.

On finalizing the installation and rebooting you should notice much improved disk and network performance and the hypervisor will now be able to gracefully shutdown your Windows domains.

Another slightly different version of James Harper's drivers can be found [here](https://github.com/spurious/win-pvdrivers-mirror).

# 14 å¯åŠ¨GUIå®¢æˆ·æœºï¼ˆä½¿ç”¨VNCæœåŠ¡å™¨ï¼‰ 

<div id="14"></div>

Here is the command to start the domain and connect to it via VNC from your graphical machine.

    xl create windows.cfg

The VNC display should be available on port 5900 of your dom0 IP, for instance using gvncviewer:

    gvncviewer <dom0-ip-address>:5900

If this does not work try it without the port number and if you are trying from a GUI on dom0, try specifying localhost instead of the dom0 ip:

    gvncviewer localhost

# 15 Conclusion

That concludes our introduction to the Xen Project software, by now you can setup both PV and HVM domains on a bare dom0 hypervisor!

You can now move onto building your own guest images or try out some prebuilt [Guest VM Images](https://wiki.xenproject.org/wiki/Guest_VM_Images).