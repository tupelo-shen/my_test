# 1 数据包管理

TCP/IP 是一种数据通信机制，因此，协议栈的实现本质上就是对数据包的传输进行管理。合理的数据包管理能够提供一种有效的机制，使使协议栈各层能对数据包进行灵活的处理，同时减少数据在各层间传递时的时间与空间开销，这是提高协议栈工作效率的关键点。在 LwIP 中，也有个类似的结构，称之为`pbuf`，本章所有讨论将围绕`pbuf`而展开。 

#### 1.1 数据包结构

在 LwIP 中，文件`pbuf.h`和`pbuf.c`实现了协议栈数据包管理相关的所有数据结构和函数。结构`pbuf`的定义如下：

    ————pbuf.h————————————————————
    struct pbuf{
        struct pbuf     *next;      // 构成 pbuf 链表时指向下一个 pbuf 结构
        void            *payload;   // 数据指针，指向该 pbuf 所记录的数据区域
        u16_t           tot_len;    // 当前 pbuf 及其后续所有 pbuf 中包含的数据总长度
        u16_t           len;        // 当前 pbuf 的数据长度 
        u8_t            type;       // 当前 pbuf 的类型
        u8_t            flags;      // 状态位，未用到
        u16_t           ref;        // 指向该 pbuf 的指针数，即该 pbuf 被引用的次数
    };
    ————————————————————————————————

`tot_len`表示当前`pbuf`和其后所有`pbuf`的有效数据的总长度。`pbuf`链表中第一个`pbuf`的`tot_len`字段表示整个数据包的长度，而最后一个`pbuf`的`tot_len`字段必同`len`字段相等 。

#### 1.2 pbuf类型

`pbuf`有4类：`PBUF_RAM`、`PBUF_ROM`、`PBUF_REF`、`PBUF_POOL`，使用了一个专门的枚举类型`pbuf_type`来描述它们：

    ————pbuf.h—————————————————————
    typedef enum {
       PBUF_RAM,        // pbuf 描述的数据在 pbuf 结构之后的连续内存堆中
       PBUF_ROM,        // pbuf 描述的数据在 ROM 中
       PBUF_REF,        // pbuf 描述的数据在 RAM 中，但位置与 pbuf 结构所处位置无关
       PBUF_POOL        // pbuf 结构与其描述的数据处于同一内存池中
    } pbuf_type;
    ————————————————————————————————

1. `PBUF_RAM`类型的`pbuf`空间

    是通过内存堆分配得到的。这种类型的`pbuf`在协议栈中是使用得最多的，协议栈的待发送数据和应用程序的待发送数据一般都采用这个形式。下面来看看源代码是怎样申请`PBUF_RAM`型的，在后续讲解函数源代码时也会详细说到。

    分配成功的`PBUF_RAM`类型`pbuf`如图1­1所示。

    从图中可看出 pbuf 结构和相应数据在一片连续的内存区域中，