### 6.4.2  x86

带有VCPU绑定的TCB有两种执行模式：一个是原始线程，就像没有绑定VCPU一样，另一个是使用VCPU的来宾模式执行。从常规执行模式切换到来宾执行模式是通过seL4_VMEnter()系统调用完成的。执行这个系统调用会使线程在调度之后，用VCPU控制的更高特权模式运行。如果来宾执行模式产生任何类型的错误，或者有消息到达TCB绑定的通知对象，那么TCB将切换回常规模式，这时seL4_VMEnter()系统调用将返回一条指示退出原因的消息。

VCPU的状态和执行可以通过seL4_VCPU_ReadVMCS()和seL4_VCPU_WriteVMCS()调用来控制。这些都是硬件vmread和vmwrite指令的非常简单的包装，内核仅对参数进行足够的验证，以确保VCPU没有被配置为违反任何的内核属性。例如，不可能禁用*外部中断退出*设置，因为这将阻止内核接收定时器中断并使得线程独占CPU时间。

通过使用扩展页表(EPT)可以控制来宾执行模式的内存访问。内核提供一系列与EPT相关的分页结构对象(EPTPML4、EPTPDPT、EPTPD、EPTPT)，它们的操作方式与常规虚拟地址空间中的对象完全相同。一旦构建了相关对象，就可以通过seL4_TCB_SetEPTRoot()为TCB设置一个EPTPML4作为EPT根页表，它就是来宾模式下的根VSpace，而seL4_TCB_SetSpace()或seL4_TCB_Configure()设置的根VSpace继续提供常规模式下的地址翻译。

直接I/O端口访问可以通过seL4_X86_VCPU_EnableIOPort()赋予给(来宾)特权执行模式，这将所提供的I/O端口能力链接到VCPU，以允许VCPU访问其能力范围内的I/O端口子集。链接意味着I/O端口能力只能作用于单次seL4_X86_VCPU_EnableIOPort()系统调用，第二次调用将撤销前一次的设置。如果I/O端口能力由于任何原因被删除，则相应的I/O端口访问许可也会从VCPU中删除。
