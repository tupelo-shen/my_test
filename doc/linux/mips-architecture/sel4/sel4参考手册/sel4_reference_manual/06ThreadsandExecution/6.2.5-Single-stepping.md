### 6.2.5  调试异常：单步执行

内核为用户空间线程提供了硬件单步执行的支持(当设置CONFIG_HARDWARE_DEBUG_API时)。为此引入了seL4_TCB_ConfigureSingleStepping系统调用。

调用者可以选择一个与指令断点相对应的寄存器API-ID，以便在设置单步执行功能时使用(如，API-ID可选0至seL4_NumExclusiveBreakpoints - 1)。但并不是所有的硬件平台都需要一个实际的硬件断点寄存器来提供单步执行功能。如果调用者的硬件平台需要使用，可以使用参数bp_num来指定[^1]，并且系统调用返回值中的bp_was_consumed字段会设置true来指示这种情况；如果不需要，那么seL4将在bp_was_consumed中返回false，bp_num也就没使用。

如果bp_was_consumed为真，则调用者不应尝试重新配置bp_num断点或监视点的用途，直到调用者禁用了单步执行并释放了该寄存器 - 要么通过seL4_TCB_ConfigureSingleStepping系统调用，要么通过num_instructions为0的错误响应，这将禁用单步执行。

在需要为单步执行功能配置实际硬件寄存器的体系架构上，seL4限制可配置寄存器的数量在任何时候都为一个。当前单步调试寄存器(如果有的话)将始终为最后一次系统调用中bp_num参数指定的寄存器[^2]。

内核也支持单步执行在产生并传递中断消息之前跳过一定数量的指令。当单步执行时，num_instructions应该设置为1，或者设置为其它非零整数值以跳过相应数量的指令。这个跳过计数也可以在单步调试错误响应消息中设置。

发送值 | 响应的寄存器值 | IPC缓冲区位置
--- | --- | ---
断点指令地址 | 要跳过的指令数num_instructions | IPCBuffer[0]
异常原因 | - | IPCBuffer[1]

表6.3 单步执行错误消息格式

[^1]: 即前面所说的断点寄存器API-ID。

[^2]: 原文表述“由错误响应消息隐含指定”，这是错误的：如前所述负责单步执行的硬件断点寄存器不能中途改变用途，而且seL4目前也不支持在一个错误响应消息中先禁用单步执行再重设硬件寄存器。
