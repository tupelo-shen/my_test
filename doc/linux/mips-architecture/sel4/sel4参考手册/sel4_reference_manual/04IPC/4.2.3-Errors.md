### 4.2.3 错误

能力传递中的错误可能发生在两个地方：发送阶段或接收阶段。在发送阶段，内核将查找调用者试图发送的所有能力，以确保在启动发送之前这些能力确实存在。如果查找由于任何原因失败，seL4_Send()和seL4_Call()系统调用将立即中止，不会发生IPC或能力传输。系统调用将返回一个查找失败错误[^1]，如第10.1节所述。

在接收阶段，seL4按照发送线程IPC缓冲区caps数组中的顺序传递能力，并在遇到错误时立即终止。可能的错误条件为:

- 查找不到源能力。虽然源能力的存在性在发送线程执行系统调用时已进行了检查，但在接收阶段这个错误仍然可能发生。在发送线程与接收线程接上头之前，它可能已在端点上阻塞了一段时间，在这期间，它的CSpace可能已经改变，而导致源能力句柄不再有效。

- 查找不到目标slot。与send类系统调用不同的是，seL4_Recv()不在初始化接收时检查目标slot是否存在且为空。因此，seL4_Recv()系统调用不会因为目标slot无效而失败，而是继续执行，直至在接收能力标记、尝试保存能力于目标slot时才标识出这种情况。

- 要传递的能力不能导出，即不能有子能力。详见3.1.5节。

一个错误不会使整个传输无效，它只会提前结束传输。在错误发生之前处理的能力已经被传递，并且接收方IPC缓冲区extraCaps字段会被设置为实际传递的能力数量。在上述任何一种情况下，内核都不会向接收线程返回错误消息[^2]。

[^1]: seL4_Send()不返回错误。

[^2]: 指内核不返回类似EXCEPTION_SYSCALL_ERROR这样专门的错误消息。开发者需根据应用实际对消息进行识别处理。
