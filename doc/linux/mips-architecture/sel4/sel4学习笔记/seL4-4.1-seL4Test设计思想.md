[TOC]

## 1 介绍

`seL4test`是一个在`seL4`之上运行测试用例的`seL4`测试框架。用于测试内核和用户态代码。

## 2 动机

即使`seL4`是一个经过验证的微内核，我们仍然需要一组全面的测试，可以用来轻松地检查内核是否在工作。

下面是我们这样做的理由：

- 验证需要花费大量的时间；而运行这些测试用例可以方便地快速地进行代码迭代；

- 验证没有覆盖所有的配置选项和平台；而这些测试用例涵盖了所有的配置选项和平台；

- 验证是一种假设：而测试恰恰可以验证这种假设是否正确；

- 验证正确的配置和工具链:测试可用于检查构建配置和已安装的主机依赖项集是否正常工作；

- 可以帮助更正确地使用内核API接口：测试用例可以证明一些边界值的处理是否正确；

- 方便测试用户态的程序（尤其是seL4提供的一些服务接口）；

## 3 目标

为了实现上述目标，添加到`sel4test`的每个测试都应该具有以下属性，其优先级顺序大致如下:

- 测试的独立性：每个用例的行为都不能影响其它用例的运行；

- 测试结果必须是明确的，成功或失败：成功表示可以正确工作，失败表示不能正确工作；

- 测试是可重复的：测试是确定的，重新运行可以得到相同结果；

- 测试是自包含的，不依赖于任何外部的交互：一个测试不应该使用它自己的测试环境之外的依赖项；

- 测试快速完成:每个测试都应该快速完成，因为整个测试持续时间是所有单个测试的累积。每次测试的时间不应超过10毫秒。

- 测试容易理解:学习和理解测试的行为不需要很大的认知负荷。

- 测试易于添加/删除:添加和删除测试是一种常见操作，执行起来应该不会很昂贵。这包括运行测试以确认其功能正确。


## 4 功能

该工程具有以下组件/功能：

#### 4.1 Root任务

`sel4test-driver`作为`seL4`的root任务运行。在其中，给定`seL4`的初始能力集（`seL4_Bootinfo_t`），并且使用它们引导自己的系统环境，为所有的测试用例创建运行环境。它提供了基本的操作系统功能，创建和销毁多个测试运行，并且支持不同的测试环境。

#### 4.2 测试环境

测试环境定义了一个测试运行的时候可以访问的资源。这个环境包括启动（start-up）和关闭（shut-down）过程。测试的定义中，有一个测试环境属性，用于连接到它要求的测试环境。

#### 4.3 Bootstrap环境

每个测试环境，在从root任务独立出来的进程中运行测试用例。这样做，保证了测试用例之间彼此的隔离。但是，有一个`bootstrap`引导测试环境，在root任务中运行测试用例。这个环境，用于测试创建不同环境的进程，并在彼此之间通信的功能。

#### 4.4 测试选择

将对测试用例的引用添加到特定的链接器（linker）段中，在运行时，`roottask`使用这个选择并运行相应的测试。测试用例的选择，依赖于测试是否被使能以及测试名称是否与roottask中配置的正则表达式匹配。期望测试能够在build阶段根据build配置自动选择是否使能。正则表达式进一步控制是否运行测试。默认的正则表达式是`.*`，选择所有使能的测试用例。

#### 4.6 测试运行

测试顺序执行，测试环境在每个测试开始前会被复位。`roottask`可以根据测试结果作为条件判断是否继续运行。一个测试用例的失败，不会导致整个应用崩溃。这不是绝对的，有些测试内核机制的用例，可能会故意崩溃整个系统。

#### 4.7 报告结果

测试结果通过一组通用测试API接口给出。`roottask`可以选择如何报告结果。比如说，报告的格式应该支持机器可解析的，这样方便自动化测试。人类可读格式也应该支持。

## 5 其它参考

`seL4bench`是一个与`seL4test`类似的工程，用于在`seL4`上运行基准测试。
